var Attend=Attend||{};Attend.Messager={checkinMessager:null,checkoutMessager:null,lateMessager:null,leaveMessager:null,outTime:[],checkinMsg:null,checkoutMsg:null,currTime:null,currMsg:{checkin:false,checkout:false},delayedMsg:[],reGet:null,getCheckinTips:function(){var a=this;$.ajax({type:"GET",dataType:"json",url:"/app/attend/getcheckintips",success:function(c){if(c.success&&c.data){var b=c.data.tips;a.currTime=c.data.currtime;a.setMessager(b)}},error:function(){}})},getTime:function(){if(this.currTime===null){var a=Date.parse(new Date());a=a.toString();a=a.substring(0,10);return a}return this.currTime},calculateTime:function(b){var a=this.getTime();a=a*1000;b=b*1000;return b-a},getExpireTime:function(){var a=new Date(),b=Date.parse(a);a.setDate(a.getDate()+1);a.setHours(0,0,0,0);return a-b},setMessager:function(a){if(a===null){return}var g=this,e=false,c=a.checkin,b=a.checkout;g.outTime.checkin=c.outtime;g.outTime.checkout=b.outtime;if(c.isshow&&!g.currMsg.checkin){g.showMessager(0)}else{if(!c.isshow&&c.starttime!="^off"){e=true;var h=g.calculateTime(c.starttime);if(h>0){g.delayedMsg[0]=setTimeout(function(){if(g.reGet!==null){clearTimeout(g.reGet)}g.showMessager(0)},h)}}}if(b.isshow&&!g.currMsg.checkout){g.showMessager(1)}else{if(!b.isshow&&b.starttime!="^off"){e=true;var h=g.calculateTime(b.starttime);if(h>0){g.delayedMsg[1]=setTimeout(function(){if(g.reGet!==null){clearTimeout(g.reGet)}g.showMessager(1)},h)}}}var f=Cookie.get("CHECKIN-MSG"),d=Cookie.get("CHECKOUT-MSG");if(e&&(f===null||d===null)){g.reGet=setTimeout(function(){g.getCheckinTips()},1800000)}},showMessager:function(a){if(a==1){this.initCheckoutMessager()}else{this.initCheckinMessager()}},initCheckinMessager:function(){var b=this,a=Cookie.get("CHECKIN-MSG");if(a!==null&&a){return}if(this.checkinMessager===null){this.checkinMessager=Messager.window({id:"checkin-messager",title:"\u6e29\u99a8\u63d0\u793a",initClose:false,showTimer:true,timeFrom:"/app/attend/getTime",anims:{type:"fade",speed:800},body:'<div style="padding:21px"><p>\u6e29\u99a8\u63d0\u793a\uff1a\u4eca\u5929\u60a8\u8fd8\u6ca1\u6709\u7b7e\u5230\u54e6\uff01</p><p>\u73b0\u5728\u65f6\u95f4\uff1a<span class="timer"></span></p></div>',footer:'<button type="button" name="btn-checkin" class="btn">\u7b7e\u5230</button><button type="button" name="after" class="btn">\u7a0d\u540e\u518d\u7b7e</button>',onClose:function(){b.checkinMessager=null},init:function(){b.currMsg.checkin=true;this.find("a.close").click(function(){b.checkinMessager.close();Cookie.set("CHECKIN-MSG",1,{expires:b.getExpireTime()})});this.find('button[name="after"]').click(function(){var c=Date.parse(b.checkinMessager.getTime());c=c.toString();c=c.substring(0,10);b.checkinMessager.close();if(b.outTime.checkin!="^off"&&parseInt(c)<=b.outTime.checkin){b.currMsg.checkin=true;b.checkinMsg=setTimeout(function(){b.initCheckinMessager()},600000)}});this.find('button[name="btn-checkin"]').click(function(){b.closeCheckinMessager();Attend.Checkin.signIn(0,function(d){if(d.success&&d.data){var c=d.data.status;if(c==1||c==3){b.initLateMessager()}b.getCheckinTips()}})})}})}this.checkinMessager.show()},initCheckoutMessager:function(){var b=this,a=Cookie.get("CHECKOUT-MSG");if(a!==null&&a){return}if(this.checkoutMessager===null){this.checkoutMessager=Messager.window({id:"checkout-messager",title:"\u6e29\u99a8\u63d0\u793a",initClose:false,showTimer:true,timeFrom:"/app/attend/getTime",anims:{type:"fade",speed:800},body:'<div style="padding:21px"><p>\u6e29\u99a8\u63d0\u793a\uff1a\u4e0b\u73ed\u4e0d\u8981\u5fd8\u8bb0\u7b7e\u9000\u54e6\uff01</p><p>\u73b0\u5728\u65f6\u95f4\uff1a<span class="timer"></span></p></div>',footer:'<button type="button" name="btn-checkout" class="btn">\u7b7e\u9000</button><button type="button" name="after" class="btn">\u7a0d\u540e\u518d\u7b7e</button>',onClose:function(){b.checkoutMessager=null},init:function(){b.currMsg.checkout=true;this.find("a.close").click(function(){b.checkoutMessager.close();Cookie.set("CHECKOUT-MSG",1,{expires:b.getExpireTime()})});this.find('button[name="after"]').click(function(){var c=Date.parse(b.checkoutMessager.getTime());c=c.toString();c=c.substring(0,10);b.checkoutMessager.close();if(b.outTime.checkout!="^off"&&parseInt(c)<=b.outTime.checkout){b.currMsg.checkout=true;b.checkoutMsg=setTimeout(function(){b.initCheckoutMessager()},600000)}});this.find('button[name="btn-checkout"]').click(function(){b.closeCheckoutMessager();Attend.Checkin.signIn(1,function(d){if(d.success&&d.data){var c=d.data.status;if(c==2){b.initLeaveMessager()}}})})}})}this.checkoutMessager.show()},initLateMessager:function(){var a=this;if(this.lateMessager===null){this.lateMessager=Messager.window({id:"late-messager",title:"\u6e29\u99a8\u63d0\u793a",autoCloseTime:5000,anims:{type:"fade",speed:800},body:'<div style="padding:35px 21px;"><p>\u4eca\u5929\u60a8\u8fdf\u5230\u4e86\uff0c\u660e\u5929\u53ef\u4e0d\u8981\u518d\u8fdf\u5230\u54af~</p></div>',footer:'<button type="button" name="confirm" class="btn">\u786e\u5b9a</button>',init:function(){this.find('button[name="confirm"]').click(function(){a.lateMessager.close()})},onClose:function(){a.lateMessager=null}})}this.lateMessager.show()},initLeaveMessager:function(){var a=this;if(this.leaveMessager===null){this.leaveMessager=Messager.window({id:"unwork-messager",title:"\u6e29\u99a8\u63d0\u793a",autoCloseTime:5000,anims:{type:"fade",speed:800},body:'<div style="padding:35px 21px;"><p>\u4eca\u5929\u60a8\u65e9\u9000\u4e86\uff0c\u5982\u679c\u6709\u4e8b\u8bb0\u5f97\u5148\u8bf7\u5047\u54e6\uff01</p></div>',footer:'<button type="button" name="confirm" class="btn">\u786e\u5b9a</button>',init:function(){this.find('button[name="confirm"]').click(function(){a.leaveMessager.close()})},onClose:function(){a.leaveMessager=null}})}this.leaveMessager.show()},closeCheckinMessager:function(){if(this.checkinMessager!==null){this.checkinMessager.close()}},closeCheckoutMessager:function(){if(this.checkoutMessager!==null){this.checkoutMessager.close()}},clearCheckinMsg:function(){if(this.checkinMsg!==null){clearTimeout(this.checkinMsg);this.checkinMsg=null}},clearCheckoutMsg:function(){if(this.checkoutMsg!==null){clearTimeout(this.checkoutMsg);this.checkoutMsg=null}},clearDelayedMsg:function(a){if(typeof this.delayedMsg[a]!="undefined"&&this.delayedMsg[a]!==null){clearTimeout(this.delayedMsg[a]);this.delayedMsg[a]=null}}};Attend.Checkin={_lang:{checkin:"\u4e0a\u73ed\u7b7e\u5230"},setLang:function(c){var a=this;for(var b in c){a._lang[b]=c[b]}},init:function(){var a=this;$('input[name="checkin"]').click(function(){TOP.Attend.Messager.clearDelayedMsg(0);TOP.Attend.Messager.clearCheckinMsg();TOP.Attend.Messager.closeCheckinMessager();var b=$('input[name="checkin"]');a.signIn(0,function(e){if(e.success&&e.data){var c=e.data.status;if(c==1||c==3){TOP.Attend.Messager.initLateMessager()}TOP.Attend.Messager.getCheckinTips();if(b.hasClass("first")){var f=e.data,d="checkin",g=a._lang.checkin;g=g+"("+f.time+")";$('input[name="'+d+'"]').val(g);$("span."+d).html("("+f.ip+"&nbsp;"+f.address+")");$('input[name="'+d+'"]').attr("disabled",true)}else{location.assign(location.href)}}})});$('input[name="checkout"]').click(function(){TOP.Attend.Messager.clearDelayedMsg(1);TOP.Attend.Messager.clearCheckoutMsg();TOP.Attend.Messager.closeCheckoutMessager();a.signIn(1,function(c){if(c.success&&c.data){var b=c.data.status;if(b==2||b==3){TOP.Attend.Messager.initLeaveMessager()}location.assign(location.href)}})});$("#month").bind("change",function(){var c=$("#year").val(),d=$(this).val(),b=$("#unid").val();a.loadCalendar(c,d,b)});$("#year").bind("change",function(){var c=$(this).val(),d=$("#month").val(),b=$("#unid").val();a.loadCalendar(c,d,b)})},loadCalendar:function(b,c,a){$("#schedule-calendar").load("/app/attend/schedule/calendar?year="+b+"&month="+c+"&unid="+a)},signIn:function(a,c){var b=this;$.ajax({type:"POST",dataType:"json",url:"/app/attend/checkin",data:{type:a},success:function(d){TOP.showMessage(d.message,5000,d.success?"success":null);if(typeof c=="function"){c.call(b,d)}},error:function(d){TOP.showMessage(TOP.TEXT.PROCESSING_ERROR)}})}};Attend.Infowin={win:null,winTpl:['<div class="pop">','<div class="pop_header"><strong id="win-title"></strong><a class="icon icon_close close"></a></div>','<div class="pop_body" style="height:250px;padding:0;overflow:auto;">','<div id="win-content" style="padding: 10px 22px;"></div>',"</div>",'<div class="pop_footer">','<button type="button" name="close" class="btn">\u5173\u95ed</button>',"<div>","</div>"].join(""),show:function(b,e,a,c){var d=this;d.win=TOP.appendWindow("infowin",d.winTpl,{width:500,draggable:true,onShow:function(){d.win.find('a.icon_close, button[name="close"]').bind("click",function(){d.win.close();return false});d.getInfo(b,e,a,c)},onClose:function(){d.win.destroy()}});d.win.show()},getInfo:function(c,a,b,d){var e=this,f=TOP.getJQ();f("#win-content").load("/app/attend/attend/applyinfo?cid="+c+"&unid="+a+"&year="+b+"&month="+d)}};Attend.Count={checkinInfoTpl:['<div class="pop">','<div class="pop_header"><strong id="win-title">\u8003\u52e4\u660e\u7ec6</strong><a class="icon icon_close close"></a></div>','<div class="pop_body">','<table border="0" cellspacing="0" cellpadding="6" class="attendance_table">','<tr><th align="right">\u67e5\u8be2\u65e5\u671f\uff1a</th><td id="date"></td></tr>','<tr><th align="right">\u4e0a\u73ed\u7b7e\u5230\uff1a</th><td><span id="checkintime">-</span>&nbsp;<span class="gray" id="checkin-ip"></span></td></tr>','<tr><th align="right">\u4e0b\u73ed\u7b7e\u9000\uff1a</th><td><span id="checkouttime">-</span>&nbsp;<span class="gray" id="checkout-ip"></span></td></tr>','<tr><th align="right">\u5de5\u4f5c\u65f6\u957f\uff1a</th><td id="worktime">0\u5c0f\u65f60\u5206</td></tr>','<tr><th align="right">\u8003\u52e4\u72b6\u51b5\uff1a</th><td id="status">-</td></tr>','<tr name="memo" style="display:none;"><th align="right" valign="top">\u5907\u6ce8\uff1a</th><td><div class="remark_info" style="width:380px;"></div></td></tr>',"</table>","</div>",'<div class="pop_footer">','<button type="button" name="close" class="btn">\u5173\u95ed</button>',"<div>","</div>"].join(""),checkinInfoWin:null,init:function(){var b=null;TOP.keyhint("#keywords","gray",true,document.body);$("#count-list tr").mousemove(function(){$(this).addClass("current")}).mouseout(function(){$(this).removeClass("current")});$('input[name="search"]').bind("click",function(){var g=$("#year option:selected").val(),h=$("#month option:selected").val(),d="/app/attend/count/index?year="+g+"&month="+h;if($("#deptid").size()){var f=$("#deptid option:selected").val();d+="&deptid="+f}if($("#keywords").size()){var e=$("#keywords").val()!=$("#keywords").attr("title")?$("#keywords").val().replace(/^\s+|\s+$/,""):"";d+="&keywords="+encodeURIComponent(e)}location.href=d});var a=$("table.table_list").outerWidth(true);function c(){var d=document.body.offsetWidth,e=Math.max(a,d-10);if(a>=d){e+=40}$(".tab-panel-body").css("width",e);b=null}window.onresize=function(){if(b==null){b=setTimeout(function(){c()},100)}};c()},initList:function(d){var c=this,b=null;TOP.keyhint("#keywords","gray",true,document.body);if($("#nunid").val()){$("#keywords").change(function(){$("#nunid").val("")})}$("#count-list tr").mousemove(function(){$(this).addClass("current")}).mouseout(function(){$(this).removeClass("current")});$('input[name="search"]').bind("click",function(){var g=$("#unid").val(),k=$("#year option:selected").val(),l=$("#month option:selected").val(),j=$("#categoryid  option:selected").val(),h="/app/attend/count/list?&year="+k+"&month="+l+"&categoryid="+j;if($("#keywords").size()){var i=$("#keywords").val()!=$("#keywords").attr("title")?$("#keywords").val().replace(/^\s+|\s+$/,""):"";h+="&keywords="+encodeURIComponent(i)}if(typeof i!="undefined"&&i.length>0){var f=$("#nunid").val();if(!f){location="/app/attend/count/index?year="+k+"&month="+l+"&keywords="+encodeURIComponent(i);return}else{g=f}}h+="&unid="+g+"&back="+d;location.href=h});new $.autocomplete({target:$("#keywords"),data:{users:TOP.Cast.get("attend")},url:"/frame/cast",onLoaded:c.castLoaded,columns:{users:["truename","username","pinyin"]},width:165,arrowSupport:true,template:{users:'{truename} <span class="gray">&lt;{username}&gt;</span>'},onSelect:function(f){$("#keywords").val(f.data.truename);$("#nunid").val(f.data.uniqueid)}});var a=$("table.table_list").outerWidth(true);function e(){var f=document.body.offsetWidth,g=Math.max(a,f-10);if(a>=f){g+=40}$(".tab-panel-body").css("width",g);b=null}window.onresize=function(){if(b==null){b=setTimeout(function(){e()},100)}};e()},castLoaded:function(a){TOP.Cast.set("users",a.data.users);TOP.Cast.set("depts",a.data.depts);TOP.Cast.set("groups",a.data.groups);var g=a.data.users,d=[],e=Attend.Count.deptIds;if(e.length>0){for(var b=0,f=g.length;b<f;b++){if(TOP.Util.inArray(g[b].deptid,e)){d.push(g[b])}}this.data={users:d};TOP.Cast.set("attend",d)}else{this.data={users:g};TOP.Cast.set("attend",g)}},deptIds:[],setDepts:function(a){this.deptIds=a},showCheckinInfo:function(a,b){var c=this;c.checkinInfoWin=TOP.appendWindow("checkininfo",c.checkinInfoTpl,{width:500,draggable:true,onShow:function(){c.checkinInfoWin.find('a.icon_close, button[name="close"]').bind("click",function(){c.checkinInfoWin.close();return false});c.getInfo(a,b)},onClose:function(){c.checkinInfoWin.destroy()}});c.checkinInfoWin.show()},getInfo:function(a,b){var c=this,d=TOP.getJQ();$.ajax({type:"GET",dataType:"json",url:"/app/attend/attend/info?unid="+a+"&date="+b,success:function(e){if(e.success&&e.data){var f=e.data;d("#date").text(f.date);if(typeof f.checkin!="undefined"){d("#checkintime").text(f.checkin.time);d("#checkin-ip").html("("+f.checkin.ip+"&nbsp;"+f.checkin.address+")")}if(typeof f.checkout!="undefined"){d("#checkouttime").text(f.checkout.time);d("#checkout-ip").html("("+f.checkout.ip+"&nbsp;"+f.checkout.address+")")}if(typeof f.worktime!="undefined"){d("#worktime").html(f.worktime)}if(typeof f.status!="undefined"){d("#status").html(f.status)}if(typeof f.memo!="undefined"){c.checkinInfoWin.find('tr[name="memo"]').show();d(".remark_info").html(f.memo)}c.checkinInfoWin.center()}},error:function(e){}})}};
