var Attend=Attend||{};Attend.Apply={editor:null,ccInput:null,targetInput:null,filedialog:null,upload:null,editorCss:{},init:function(e,g,b){var f=this;$('button[name="back"]').bind("click",function(){location=b});var d=$(window).height(),c=$(document.body).height(),a=Math.max($("#content").height()+(d-c-15),200);$("#content").css("height",a+"px");this.editor=new TOP.Editor(document.getElementById("content"),{resizeType:1,width:"100%",minHeight:200,themeType:"tudu",css:f.editorCss,scope:window,pasteType:2,disabled:e.editor,ctrl:{13:function(){$("#action").val("send");f.send("send")}}},jQuery);$("#map-btn").click(function(){f.editor.getEditor().loadPlugin("googlemap",function(){f.editor.getEditor().plugin.mapDialog()})});this.ccInput=new TOP.ContactInput({id:"cc-input",target:$("#i-cc"),valuePlace:$("#cc"),group:true,jq:jQuery});this.initSelectLink("#select-cc",this.ccInput,$("#cc"),true);if(g.init&&$("#row-target").size()){this.targetInput=new TOP.ContactInput({id:"target-input",target:$("#i-target"),valuePlace:$("#target"),group:false,jq:jQuery,maxCount:1,depts:g.depts,contact:false});this.initSelectLink("#select-target",this.targetInput,$("#target"),false,1,g.depts.join(","),["common"]);if(e.target){this.targetInput.disabled()}}$("#add-cc").bind("click",function(){if($(this).hasClass("disabled")){return}f.toggleCC()});$("#add-target").bind("click",function(){if(!g.init||$(this).hasClass("disabled")){return}f.toggleTarget()});$("#period").bind("keyup",function(){this.value=this.value.replace(/[^0-9.]+/,"");if(this.value.indexOf(".")!=-1){var h=this.value.split(".");if(typeof h[1]!="undefined"&&h[1].length>1){this.value=h[0]+"."+h[1].substring(0,1)}}}).blur(function(){$(this).val(this.value)});if(!TOP.Browser.isIE&&!TOP.Browser.isFF){$("#screencp-btn").remove()}else{$("#link-capture").bind("click",function(){if(!Capturer.getCapturer()){return Capturer.install()}Capturer.setEditor(f.editor);Capturer.startCapture()})}$("#netdisk-btn").click(function(){if(f.filedialog===null){f.filedialog=new FileDialog({id:"netdisk-dialog"})}f.filedialog.show()});$(':radio[name="categoryid"]').bind("click",function(){if(this.value=="^checkin"){$("#row-timetype").hide();$("#row-startdate").hide();$("#row-enddate").hide();$("#row-date").hide();$("#row-checkin").show();$("#row-checkintime").show();$("#row-total").hide();f.updateTimeInput(true)}else{f.changeCategory(this.value);$("#row-timetype").show();$("#row-checkin").hide();$("#row-checkintime").hide();var h=parseInt($(':radio[name="isallday"]:checked').val());if(h){$("#row-startdate").show();$("#row-enddate").show();$("#row-date").hide()}else{$("#row-startdate").hide();$("#row-enddate").hide();$("#row-date").show()}$("#row-total").show();f.updateTimeInput(false)}});$(':radio[name="isallday"]').bind("click",function(){var h=parseInt(this.value);if(h){$("#row-startdate").show();$("#row-enddate").show();$("#row-date").hide()}else{$("#row-startdate").hide();$("#row-enddate").hide();$("#row-date").show()}f.updateTimeInput(false)});$("#startdate").datepick({showOtherMonths:true,selectOtherMonths:true,firstDay:0,showAnim:"slideDown",showSpeed:"fast",showTimePanel:false,showButtonPanel:false,onSelect:function(h){$("#enddate").datepick("option",{minDate:h});f.updateTimeInput(false)}});$("#enddate").datepick({showOtherMonths:true,selectOtherMonths:true,firstDay:0,showAnim:"slideDown",showSpeed:"fast",showTimePanel:false,showButtonPanel:false,onSelect:function(h){$("#startdate").datepick("option",{maxDate:h});f.updateTimeInput(false)}});$("#date").datepick({showOtherMonths:true,selectOtherMonths:true,firstDay:0,showAnim:"slideDown",showSpeed:"fast",showTimePanel:false,showButtonPanel:false,onSelect:function(h){f.checkVal();f.updateTimeInput(false)}});$("#starthour").stepper({step:1,max:23,min:0,callback:function(){f.checkVal();f.updateTimeInput(false)}});$("#startmin").stepper({step:15,max:59,min:0,callback:function(){f.checkVal();f.updateTimeInput(false)}});$("#endhour").stepper({step:1,max:23,min:0,callback:function(){f.checkVal();f.updateTimeInput(false)}});$("#endmin").stepper({step:15,max:59,min:0,callback:function(){f.checkVal();f.updateTimeInput(false)}});$("#checkindate").datepick({showOtherMonths:true,selectOtherMonths:true,firstDay:0,showAnim:"slideDown",showSpeed:"fast",showTimePanel:false,showButtonPanel:false,onSelect:function(h){f.updateTimeInput(true)}});$("#checkinhour").stepper({step:1,max:23,min:0,callback:function(){f.updateTimeInput(true)}});$("#checkinmin").stepper({step:15,max:59,min:0,callback:function(){f.updateTimeInput(true)}});$(':radio[name="checkintype"]').bind("click",function(){f.updateTimeInput(true)});$("#theform").submit(function(){return false});$('button[name="send"],button[name="save"]').bind("click",function(){$("#action").val(this.name);f.send(this.name)});$('button[name="preview"]').click(function(){f.getFormPreview("#theform","/app/attend/apply/preview","_blank")});setTimeout(function(){f.clearCast()},1000)},updateTimeInput:function(j){if(j){if(!$(':radio[name="checkintype"]:checked').size()){return}var b=parseInt($(':radio[name="checkintype"]:checked').val()),d=$("#checkindate").val();if(!checkindate){return}var a=$("#checkinhour").val(),n=$("#checkinmin").val();if(b){$("#endtime").val(d+" "+a+":"+n);$("#starttime").val("")}else{$("#starttime").val(d+" "+a+":"+n);$("#endtime").val("")}}else{if(!$(':radio[name="isallday"]:checked').size()){return}var l=parseInt($(':radio[name="isallday"]:checked').val());if(l){var m=$("#startdate").val(),k=$("#enddate").val();$("#starttime").val(m);$("#endtime").val(k)}else{var f=$("#date").val();if(!f){return}var h=$("#starthour").val(),e=$("#startmin").val(),g=$("#endhour").val(),c=$("#endmin").val();$("#starttime").val(f+" "+h+":"+e);$("#endtime").val(f+" "+g+":"+c)}}},checkVal:function(){var c=$("#date").val();if(!c){return}var k=new Date(),h=new Date(),j=c.split("-"),g=c.split("-");k.setFullYear(j[0]);k.setMonth(j[1]);k.setDate(j[2]);h.setFullYear(g[0]);h.setMonth(g[1]);h.setDate(g[2]);if(h.getTime()>k.getTime()){return}else{if(h.getTime()==k.getTime()){var f=$("#starthour").val(),b=$("#startmin").val(),d=$("#endhour").val(),a=$("#endmin").val();k.setHours(f);k.setMinutes(b);h.setHours(d);h.setMinutes(a);if(k.getTime()>h.getTime()){$("#endhour").val(k.getHours());$("#endmin").val(k.getMinutes())}}}},changeCategory:function(a){$.ajax({method:"GET",dataType:"json",url:"/app/attend/apply/summary?categoryid="+a,success:function(c){if(c.success&&c.data){var b=$('label[for="c-'+a+'"]').text();$("#type-sum").text("\u672c\u6708\u5df2\u7533\u8bf7 "+b+" "+c.data.summary+" \u5c0f\u65f6")}},error:function(b){}})},toggleCC:function(){if(!$("#row-cc:visible").size()){$("#cc, #i-cc").attr("disabled",false);$("#row-cc").show();$("#add-cc").text(TOP.TEXT.DELETE_CC)}else{$("#cc, #i-cc").attr("disabled",true);$("#row-cc").hide();$("#add-cc").text(TOP.TEXT.ADD_CC)}},toggleTarget:function(){if(!$("#row-target:visible").size()){$("#target, #i-target").attr("disabled",false);$("#row-target").show();$("#type-sum").hide();$("#add-target").text("\u5220\u9664\u4ee3\u529e")}else{$("#target, #i-target").attr("disabled",true);$("#row-target").hide();$("#type-sum").show();$("#add-target").text("\u6dfb\u52a0\u4ee3\u529e")}},getFormPreview:function(c,a,e){$("#postcontent").val(Attend.Apply.editor.getSource());var d=$(c).serializeArray();var c=$('<form action="'+a+'" method="post" target="'+e+'" style="display:none"></form>');for(var b in d){c.append('<textarea name="'+d[b].name+'">'+d[b].value+"</textarea>")}c.append('<input name="autosave" value="1" />');c.appendTo(document.body).submit()},clearCast:function(){var a=TOP.Cast.getTime();if(a){$.ajax({type:"GET",dataType:"json",url:"/tudu/clear-cast?loadtime="+a,success:function(b){if(b.data&&b.data.clear){TOP.Cast.clear()}},error:function(){}})}},initSelectLink:function(f,g,a,e,b,d,c){if(!e){e=false}$(f).click(function(){var u=this;var s=$(this).text();var j=a.val();var m=[],o=null;if(j){j=j.split("\n");for(var n=0,r=j.length;n<r;n++){var t=j[n].split(" ");m.push({_id:t[0].replace(/^#+/,""),name:t[1]})}}else{m=null}var p='<div class="pop pop_linkman"><div class="pop_header"><strong>'+TOP.TEXT.SELECT_CONTACT+'</strong><a class="icon icon_close close"></a></div><div class="pop_body"></div><div class="pop_footer"><button type="button" name="confirm" class="btn">'+TOP.TEXT.CONFIRM+'</button><button type="button" class="btn close">'+TOP.TEXT.CANCEL+"</button></div></div>";var q=TOP.Frame.TempWindow;q.append(p,{width:470,draggalbe:true,onShow:function(){q.center()},onClose:function(){q.destroy()}});var l={appendTo:q.find("div.pop_body"),enableGroup:e,selected:m,mailInput:g,childOf:undefined!==d?d:null};if(undefined!==b){l.maxSelect=b}if(undefined!==c){l.panels=c}var k=new TOP.ContactSelector(l);var h=TOP.Cookie.get("CONTACT-PANEL");if(!h){h="common"}k.switchPanel(h);q.find('button[name="confirm"]').bind("click",function(){var w=k.getSelected();for(var v=0,y=w.length;v<y;v++){var x={};if(w[v].groupid){x.title=w[v].name+"&lt;"+TOP.TEXT.GROUP+"&gt;";x._id=w[v].groupid}else{x.title=w[v].name+(w[v].email?"$lt;"+w[v].email+"&gt;":"");x._id=w[v].email?w[v].email:""}x.name=w[v].name;g.addItem(w[v].name,x)}q.close()});q.show()})},send:function(g,l){var b=$("#theform"),d=this;if(g!="autosave"){if(!$(':radio[name="categoryid"]:checked').size()&&!$("#categoryid").val()){return TOP.showMessage("\u8bf7\u9009\u62e9\u7533\u8bf7\u7c7b\u578b")}var e=b.find('input[name="categoryid"]:checked').val();if(e!="^checkin"&&!$(':radio[name="isallday"]:checked').size()){return TOP.showMessage("\u8bf7\u9009\u62e9\u65f6\u95f4\u7c7b\u578b")}if(e=="^checkin"&&!$(':radio[name="checkintype"]:checked').size()){return TOP.showMessage("\u8bf7\u9009\u62e9\u8865\u7b7e\u7c7b\u578b")}var f=this.ccInput.getItems();i=0;if(this.targetInput!==null){var k=this.targetInput.getItems();k.each(function(){if($(this).attr("title")==TOP.TEXT.INVALID_TO_USER){i++}})}f.each(function(){if($(this).attr("title")==TOP.TEXT.INVALID_TO_USER){i++}});if(i>0){return TOP.showMessage(TOP.TEXT.TUDU_ACCEPTER_EMAIL_ERROR)}if(e=="^checkin"&&!$("#checkindate").val()){$("#checkindate").focus();return TOP.showMessage("\u8bf7\u8f93\u5165\u8865\u7b7e\u65f6\u95f4")}if(e!="^checkin"){var j=$(':radio[name="isallday"]:checked').val();if(parseInt(j)){if(!$("#startdate").val()){$("#startdate").focus();return TOP.showMessage("\u8bf7\u8f93\u5165\u5f00\u59cb\u65f6\u95f4")}if(!$("#enddate").val()){$("#enddate").focus();return TOP.showMessage("\u8bf7\u8f93\u5165\u7ed3\u675f\u65f6\u95f4")}}else{if(!$("#date").val()){$("#date").focus();return TOP.showMessage("\u8bf7\u8f93\u5165\u5f00\u59cb\u65f6\u95f4")}}if(!$("#period").val()){$("#period").focus();return TOP.showMessage("\u8bf7\u8f93\u5165\u7533\u8bf7\u5c0f\u65f6\u603b\u6570")}}if(!TOP.Device.iOS&&!TOP.Device.Android&&this.editor!==null&&this.editor.isNull()){this.editor.focus();return TOP.showMessage("\u8bf7\u8f93\u5165\u7533\u8bf7\u7406\u7531")}}if(TOP.Device.iOS||TOP.Device.Android){var a=$("#content").val();a=a.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br />")}else{var a=this.editor.getSource();if(!checkContentImage(a,this.editor,function(){d.send(g,l)})){return}var c=/<img([^>]+)src="([^"]+)"([^>]+)_aid="([^"]+)"([^>]+)\/>/ig;b.find(':hidden[name="file[]"]').remove();while((result=c.exec(a))!=null){b.append('<input type="hidden" name="file[]" value="'+result[4]+'" />')}a=a.replace(c,'<img$1src="AID:$4"$3_aid="$4"$5/>');a=a.replace(/\s+id="[^"]+"/g,"")}$("#postcontent").val(a);if(g!="autosave"){if(!whileUploading(this.upload,TOP.TEXT.WAITING_UPLOAD,function(){Modify.send(g,l)},b)){return}if($("#attach-list div.upload_error").size()){if(!confirm(TOP.TEXT.COMPOSE_UPLOAD_FAILURE)){return}}}var h=b.serializeArray();if(g!="autosave"){TOP.showMessage(TOP.TEXT.POSTING_DATA,0,"success");b.find(":input").attr("disabled",true)}$.ajax({type:"POST",dataType:"json",data:h,url:b.attr("action"),success:function(n){if(g!="autosave"){TOP.showMessage(n.message,5000,n.success?"success":null)}if(n.data){$("#ftid").val(n.data.tuduid)}if(n.success){if(typeof(l)=="function"){return l()}var m="";if(g=="send"&&n.data){if(typeof(_NEW_WIN)!="undefined"&&_NEW_WIN){m="/app/attend/apply/view?tid="+n.data.tuduid+"&newwin=1"}else{m="/app/attend/apply/view?tid="+n.data.tuduid}location=m}else{b.find(":input:not([_disabled])").attr("disabled",false)}return}else{b.find(":input:not([_disabled])").attr("disabled",false)}},error:function(m){b.find(":input:not([_disabled])").attr("disabled",false);if(g!="autosave"){TOP.showMessage(TOP.TEXT.PROCESSING_ERROR)}}})}};var FileDialog=function(a){this._settings=$.extend({},a);this.listCt=this._settings.listCt?this._settings.listCt:$("#attach-list");this.list=this._settings.list?this._settings.list:$("#attach-list td.bd_upload")};FileDialog.filetpl=['<div class="filecell"><input type="hidden" name="nd-attach[]" value="" /><input type="hidden" name="attach[]" value="" />','<div class="attsep"><div class="attsep_file"><span class="icon icon_add"></span><span class="filename"></span>&nbsp;<span class="filesize"></span></div>','<div class="attsep_del"><a href="javascript:void(0)" name="delete">'+TOP.TEXT.DELETE+"</a></div>",'<div class="clear"></div></div></div>'].join("");FileDialog.tpl='<div class="pop pop_linkman"><div class="pop_header"><strong>'+TOP.TEXT.NETDISK_ATTACH+'</strong><a class="icon icon_close close"></a></div><div class="pop_body" style="padding:10px"><p class="gray">'+TOP.TEXT.SELECT_NETDISK_FILE+'</p></div><div class="pop_footer"><button type="button" name="confirm" class="btn">'+TOP.TEXT.CONFIRM+'</button><button type="button" name="cancel" class="btn close">'+TOP.TEXT.CANCEL+"</button></div></div>";FileDialog.prototype={win:null,upload:null,_settings:null,list:null,listCt:null,init:function(){var c=TOP.Frame.TempWindow,a=this;c.append(FileDialog.tpl,this._settings.id,{width:300,draggable:true,onClose:function(){c.destroy()}});if(this._settings.upload){this.initUpload()}var b=new TOP.NetdiskPanel();b.renderTo(c.find(".pop_body"));c.find('button[name="confirm"]').click(function(){var e=b.getFileSelected();for(var d=0,f=e.length;d<f;d++){if(!e[d].fileid){continue}a.appendToAttachment(e[d].fileid,e[d].filename,e[d].filesize)}c.close()});c.show()},show:function(){this.init()},appendToAttachment:function(e,b,c){var a=this;var d=$(FileDialog.filetpl);if(a.list.find("#nd-file-"+e).size()){return}d.attr("id","nd-file-"+e).find(".filename").text(b);d.find(':hidden[name="nd-attach[]"]').val(e);d.find(':hidden[name="attach[]"]').val(e);c=c>1024?Math.round(c/1024,2)+"KB":c+"bytes",d.find(".filesize").text("("+c+")");d.find('a[name="delete"]').click(function(){d.remove();if(!a.list.find(".filecell").size()){a.listCt.hide()}});a.list.append(d);a.listCt.show()}};var Capturer={capturer:null,editor:null,uploaddialog:null,uploadurl:null,installed:null,setEditor:function(a){this.editor=a},setUploadUrl:function(a){this.uploadurl=a},install:function(){var b=[{text:TOP.TEXT.INSTALL_ONLINE,cls:"btn",events:{click:function(){if(confirm(TOP.TEXT.INSTALL_LEAVE_CONFIRM)){top.location="/plugin/screencapture?back="+encodeURIComponent(TOP.Frame.hash());a.close()}}}},{text:TOP.TEXT.CANCEL,cls:"btn close",events:{click:function(){a.close()}}}];var a=TOP.Frame.Dialog.show({title:TOP.TEXT.CAPTURER_INSTALL_TIPS,body:'<div class="screen_lock"><div><span class="icon icon_attention_big"></span><strong>'+TOP.TEXT.UNINSTALL_CAPTURER_TOOLS_TIPS+"</strong></div><ul><li>"+TOP.TEXT.AFFTER_INSTALL+TOP.TEXT.COMMA+TOP.TEXT.CLICK+'&nbsp;<span class="icon icon_screencp"></span><a>'+TOP.TEXT.CAPTURER+"</a>&nbsp;"+TOP.TEXT.COMMA+TOP.TEXT.USE_CAPTURER_NOW+"</li></ul></div>",buttons:b})},getCapturer:function(){if(null===this.capturer&&false!==this.installed){var me=this;this.capturer=new ScreenCapture({onCaptured:function(){me.uploaddialog=TOP.Frame.Dialog.show({body:"<div>"+TOP.TEXT.FILE_UPLOADING+'</div><div class="progress_large" style="width:420px;margin:10px 0"><div class="bar"></div></div>',title:TOP.TEXT.FILE_UPLOADING,close:false}).getWin()},onUploaded:function(uploader){if(uploader){me.uploaddialog.dialog.container.find("div.progress_large div.bar").css("width","95%");var response=uploader.HttpReault.match(/\{.*\}/);var ret;try{eval("ret="+response+";")}catch(e){}if(ret.fileid){if(me.editor!==null){var url="/attachment/img?fid="+ret.fileid;html='<img src="'+url+'" _aid="'+ret.fileid+'" /><br />';me.editor.pasteHTML(html)}}else{TOP.showMessage(TOP.TEXT.CAPTURER_UPLOAD_FILE_ERROR)}}else{TOP.showMessage(TOP.TEXT.CAPTURER_START_UPLOAD_ERROR)}setTimeout(function(){me.uploaddialog.hide()},500)},uploadUrl:me.uploadurl});if(!this.capturer.init()){this.capturer.destroy();this.installed=false;this.capturer=null;return null}}return this.capturer},startCapture:function(){this.getCapturer().startCapture()}};function initAttachment(g,f,a){var d={buttonImageUrl:"",buttonWidth:"70",buttonHeight:"16",buttonTextLeftPadding:20,buttonTextTopPadding:1,buttonPlaceholderId:"upload-btn",postParams:{}};for(var b in g){if(typeof(TuduUpload.defaults[b])!="undefined"){d[b]=g[b]}}$(".upload_btn").mouseover(function(){$("#upload-link").css("text-decoration","underline")}).mouseout(function(){$("#upload-link").css("text-decoration","none")});var c=new TuduUpload(d);var e=new Tudu.Attachment();e.list=f;e.container=a;e.setUpload(c);return c}function initPicInsert(e,j){var h=null;var c=j?j.auth:null,a=null,b=null;var g=menuDialog("pic-dia",{body:$("#pic-modal"),oncreate:function(){$("#pic-modal .tab-header li a").click(function(){$("#pic-modal .tab-header li").removeClass("active");var n=$(this),k=n.attr("name");n.parent().addClass("active");$("#pic-modal div.tab-body").hide();$("#tb-"+k).show()});$('#pic-modal button[name="cancel"]').click(function(){g.hide()});$('#pic-modal button[name="confirm"]').click(function(){var k=$("#picurl").val();if(k){h.pasteHTML('<img src="'+k+'" alt="" /><br />',true)}g.hide()});if(j){var m={buttonWidth:"280",buttonHeight:"24",fileTypes:"*.jpg;*.jpeg;*.gif;*.png",buttonPlaceholderId:"pic-upload-btn",postParams:{}};for(var l in j){if(typeof(TuduUpload.defaults[l])!="undefined"){m[l]=j[l]}}$(".imgupload").mouseover(function(){$('button[name="browse"]').mouseover()}).mouseout(function(){$('button[name="browse"]').mouseout()});var d=$("#filename");a=new TuduUpload(m);b=new Tudu.EditorUpload({upload:a,onFileQueue:function(o){var p=[];for(var n in this._files){p.push(this._files[n].name)}d.val(p.join(","))}});$('button[name="upload"]').click(function(){b.startUpload()})}}});g.hide();for(var f in e){$(f).mousedown(function(d){TOP.stopEventBuddle(d)}).click(function(l){h=e["#"+this.id];TOP.stopEventBuddle(l);var m=$(this).offset(),k=m.left-22,d=m.top+16;if(null!=b){b.cleanFileQueue();$("#filename").val("");b.onComplete=function(){for(var p=0,r=this._success.length;p<r;p++){var q=this._success[p].aid,n="/attachment/img?fid="+q,o='<img src="'+n+'" _aid="'+q+'" /><br />';h.pasteHTML(o)}g.hide()}}g.css({left:k,top:d}).show();$("#pic-modal .tab-header li:eq(0) a").click();$("#picfile").val("");$("#picurl").val("http://");TOP.stopEventBuddle(l)})}}function menuDialog(c,b){if(!c||!b.body){return}var a=$("#"+c);if(!a.size()){a=$("<div>").addClass("modal-dialog").attr("id",c);a.appendTo(b.appendTo?b.appendTo:document.body).bind("click",function(d){TOP.stopEventBuddle(d)});if(typeof(b.body)=="string"){a.html(b.body)}else{a.append(b.body.show())}if(typeof(b.oncreate)=="function"){b.oncreate.call(a)}$(window).bind("click",function(){a.hide()});$("#replyform").bind("click",function(){a.hide()})}a.css({position:"absolute",zIndex:100,top:b.top?b.top+"px":0,left:b.left?b.left+"px":0}).show();return a}function checkContentImage(f,k,l){var m=/<img[^>]+src="data:image\/\w+;base64,([^">]+)"([^>]+)\/>/ig;var g=f.match(m);if(!g||!g.length){return true}var h=TOP.Frame.Dialog.show({body:"<div>"+TOP.TEXT.IMG_UPLOADING+'</div><div class="progress_upload"></div>',title:TOP.TEXT.FILE_UPLOADING,close:false}).getWin();h.show();var a=0,j=g.length,e=[];for(var d=0;d<j;d++){var c=g[d],b=c.match(/data:image\/\w+;base64,[^"]+/ig);e[e.length]=c;if(!b.length){++a;continue}b=b[0].split(",")[1];$.ajax({url:"/attachment/proxy",type:"POST",dataType:"json",data:{data:b,label:d},success:function(p){if(p.success&&p.data){var o=e[p.data.label];var n=o.replace(/src="[^"]+"/,'src="/attachment/img?fid='+p.data.fileid+'"').replace(">",'_aid="'+p.data.fileid+'" >');f=f.replace(o,n);k.setSource(f)}else{TOP.showMessage(p.message)}if(++a>=j&&typeof l=="function"){h.close();l()}},error:function(n){if(++a>=j&&typeof l=="function"){h.close()}TOP.showMessage(TOP.TEXT.PROCESSING_ERROR);return false}});if(a>=j){l()}}}function whileUploading(b,f,e,d){if(null!=b){if(b.isUploading()){if(d){d.find(":input").attr("disabled",true)}b.setParam("upload_complete_handler",function(){var g=this.getStats();if(g.files_queued==0&&!g.in_progress){if(d){d.find(":input").attr("disabled",false)}if(typeof(e)=="function"){e()}}});var c=['<div class="msg-progress" id="msg-progress"><div></div></div><span id="msg-txt-progress">0%</span>',f,' [<a href="javascript:void(0);">'+TOP.TEXT.CANCEL+"</a>]"].join("");TOP.showMessage(c,0,"success");var a=b.totalProgress();TOP.getJQ()("#msg-progress div").width(a+"%");TOP.getJQ()("#msg-txt-progress").text(a+"%");TOP.getJQ()("#result-top a").click(function(){TOP.showMessage();b.setParam("upload_complete_handler",function(){}).setParam("upload_progress_handler",function(h,g,j){if(TOP.getJQ()("#msg-progress").size()){TOP.getJQ()("#msg-progress div").style("width",b.totalProgress+"%")}b.onProgress.call(this,h,g,j)});if(d){d.find(":input").attr("disabled",false)}});return false}}return true};
