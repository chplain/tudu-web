var Attend=Attend||{};var TOP=typeof(getTop)=="function"?getTop():parent;Attend.Plan={_scheduleWin:null,_scheduleWinTpl:['<div class="pop pop_linkman">','<div class="pop_header"><strong>\u9009\u62e9\u6392\u73ed\u65b9\u6848</strong><a class="icon icon_close close"></a></div>','<div class="pop_body" style="padding:10px;">','<div id="schedule-list-tree" class="calendar_cast_tree_panel" style="width:210px;"></div>',"</div>",'<div class="pop_footer"><button type="button" name="confirm" class="btn">'+TOP.TEXT.CONFIRM+'</button><button type="button" class="btn close">'+TOP.TEXT.CANCEL+"</button></div>","</div>"].join(""),_scheduleTree:null,_currSelectScid:null,_schedules:{},_plans:[],_gridData:null,_gridUsers:[],_currSchedules:null,deptIds:null,uniqueIds:null,_lang:{missing_users:"\u6ca1\u6709\u9009\u62e9\u5173\u8054\u7684\u7528\u6237",weekdays:["\u4e00","\u4e8c","\u4e09","\u56db","\u4e94","\u516d","\u65e5"]},setLang:function(d){var a=this;for(var b in d){a._lang[b]=d[b]}},init:function(e,b){var d=this;$("#save, #save-leave").bind("click",function(){d.save(this.id=="save")});$(document.body).bind("click",function(){$("#color_panel").hide(300)});$("#color_panel").bind("click",function(f){TOP.stopEventBuddle(f)});$("#cycle-month").bind("click",function(){$("#week-option").hide();$("#month-option").show();$("#cyclenum").val(1);d.initGrid(1,$("#plan-table tr.sc-tr").size(),1)});$("#cycle-week").bind("click",function(){$("#month-option").hide();$("#week-option").show();d.initGrid("week",$("#plan-table tr.sc-tr").size(),1)});$("#year, #month").bind("change",function(){var g=[];$('input[name^="user-"]').each(function(){g.push(this.value)});url="/app/attend/schedule/plan";if(g.length){url+="?email="+g.join(",");var f=$("#year").val(),h=$("#month").val();url+="&year="+f+"&month="+h+"&back="+b;location.assign(url)}});$("#add-schedule").bind("click",function(){var f=[];$("#schedule-list a").each(function(){var g=$(this).attr("_scid");f.push(g)});d.scheduleSelectWin(f)});$("#add-user").bind("click",function(){d.userSelectWin(e,false)});$("#checkall").click(function(){TOP.checkBoxAll("member[]",this.checked,document.body)});$("#add-cyclenum").bind("click",function(){var f=parseInt($("#cyclenum").val());if(f>=4){return}f++;$("#cyclenum").val(f);d.saveGrid();d.initGrid("week",$("#plan-table tr.sc-tr").size(),f);$("#remove-cyclenum").show();d.restoreGrid()});$("#remove-cyclenum").bind("click",function(){var f=parseInt($("#cyclenum").val());if(f<=1){f=1}else{f--}d.saveGrid();$("#cyclenum").val(f);d.initGrid("week",$("#plan-table tr.sc-tr").size(),f);d.restoreGrid();if(f<=1){$(this).hide()}});if(d.uniqueIds!==null){d.setGridUsers(d.uniqueIds)}else{var a=[];if(d._plans.length>0){a=this.getSelectScids()}this.refreshScheduleList(a)}},getSelectScids:function(){if(this._plans.length<=0){return}var b=[],h=this._plans;for(var e=0;e<h.length;e++){var g=h[e];for(var a in g){for(var d=0;d<g[a].length;d++){var f=g[a][d];if(!TOP.Util.inArray(f.scid,b)){b.push(f.scid)}}}}return b},scheduleSelectWin:function(a){var b=this;b._scheduleWin=TOP.appendWindow("schedule-win",b._scheduleWinTpl,{width:255,draggable:true,onShow:function(){b.initScheduleTree(a);b._scheduleWin.find('button[name="confirm"]').bind("click",function(){var d=[];b._scheduleWin.find('input[name="scheduleid[]"]').each(function(){if(this.value!="^root"&&this.value){d.push(this.value)}});if(!d.length){TOP.showMessage("\u8bf7\u81f3\u5c11\u9009\u62e9\u4e00\u4e2a\u65b9\u6848");return false}b.refreshScheduleList(d);b._scheduleWin.close()})},onClose:function(){b._scheduleTree.clear();b._scheduleTree=null;b._scheduleWin.destroy();b._scheduleWin=null}});b._scheduleWin.show()},initScheduleTree:function(d){var h=this,b=TOP.getJQ(),e=this._schedules;h._scheduleTree=new b.tree({id:"schedule-tree",idKey:"id",idPrefix:"schedule-",cls:"cast-tree"});for(var f in e){var n=e[f];var a=new b.treenode({data:{id:"s-"+n.scheduleId.replace("^","_"),scheduleid:n.scheduleId,name:n.name,title:n.title,parentid:n.parentid},isLeaf:false,content:'<input type="checkbox" name="scheduleid[]" value="{scheduleid}" /><span title="{title}">{name}</span>',events:{click:function(i){h._scheduleTree.find(this.id.replace("schedule-",""),true).toggle();TOP.stopEventBuddle(i)}}});if(n.parentid){var m=h._scheduleTree.find("s-"+n.parentid.replace("^","_"),true);if(m){m.appendChild(a)}else{h._scheduleTree.appendNode(a)}}else{h._scheduleTree.appendNode(a)}var g=new b.checkbox({name:"scheduleid[]",id:"schedule-"+n.scheduleId.replace("^","_"),replace:a.ele.find(':checkbox[name="scheduleid[]"]'),states:{normal:{value:"",cls:""},half:{value:"",cls:"checkbox-half"},checked:{value:n.scheduleId,cls:"checkbox-checked"}}});g.bind("click",function(i){if(this.state()==="half"){this.state("checked")}TOP.stopEventBuddle(i)})}var j=h._scheduleTree.find("s-_root",true);if(j){j.expand()}h._scheduleTree.appendTo(b("#schedule-list-tree"));if(d.length>0){for(var f=0;f<d.length;f++){TOP.getCheckbox("id","schedule-"+d[f].replace("^","_"),b("#schedule-tree")).state("checked")}p("_root")}var l=TOP.getCheckbox("name","scheduleid[]",b("#schedule-tree"));l.bind("click",function(){var q=b("#schedule-s-"+this.id.replace("schedule-",""));o(q.find("ul"),this.state());var r=h._scheduleTree.find("s-"+this.id.replace("schedule-",""),true);if(r.get("parentid")){p(r.get("parentid"))}var i=r.get("parentid")?b("#schedule-s-"+r.get("parentid")):b("#schedule-tree");if(k(b("#schedule-tree"))){TOP.getCheckbox("id","schedule-_root",i).state("checked")}else{TOP.getCheckbox("id","schedule-_root",i).state("normal")}});function p(s){s=s.replace("^","_");var t=h._scheduleTree.find("s-"+s,true),i=TOP.getCheckbox("id","schedule-"+s,b("#schedule-tree")),r=b("#schedule-s-"+s+" ul"),q;if(k(r)){q="checked"}else{if(r.find("div.checkbox-checked").size()){q="half"}else{q="normal"}}i.state(q);if(t.get("parentid")){p(t.get("parentid"))}}function k(r){var i=TOP.getCheckbox("name","scheduleid[]",r),q=true;i.each(function(){if(this.state()!=="checked"){q=false;return}});return q}function o(i,q){TOP.getCheckbox("name","scheduleid[]",i).state(q)}},selectColor:function(e,d,h){var g=$(e),a=$("#color_panel"),f=g.offset(),b=this;if($("#color_panel:visible").size()){a.hide()}a.css({top:f.top+g.height()+"px",left:f.left+"px"}).show(300);a.find("div.color_block").unbind("click").bind("click",function(){var i=$(this).find('input[name="color"]').val();a.hide(300);if(!d){$("#theform").find('input[name="bgcolor"]').val(i);g.css("background-color",i)}else{var j=typeof g.parent().attr("_scid")!="undefined"?j=g.parent().attr("_scid"):j=g.attr("_scid");$.ajax({type:"POST",dataType:"json",url:"/app/attend/schedule/updatecolor",data:{scheduleid:j,bgcolor:i},success:function(k){TOP.showMessage(k.message,5000,k.success?"success":null);if(k.success){g.css("background-color",i);if(typeof h=="function"){h.call(b,j,i)}}},error:function(k){}})}})},initExemption:function(b){var a=this;$("#add-user").bind("click",function(){a.userSelectWin(b,true)});$("#user-box").bind("click",function(f){var g=f.srcElement?$(f.srcElement):$(f.target);var d=g.closest("p");d.remove()}).bind("mouseover mouseout",function(d){var f=d.srcElement?$(d.srcElement):$(d.target);f=f.closest("p");if(d.type=="mouseover"){f.addClass("over")}else{f.removeClass("over")}});$("#theform").submit(function(){return false});$(".color_grid").click(function(d){a.selectColor(this,true);TOP.stopEventBuddle(d)});$(document.body).bind("click",function(){$("#color_panel").hide(300)});$("#color_panel").bind("click",function(d){TOP.stopEventBuddle(d)});$("#save").bind("click",function(){a.saveExemption()})},saveExemption:function(){var a=$("#theform");var b=a.serializeArray();if(!$('input[name="user[]"]').size()){return TOP.showMessage(this._lang.missing_users)}a.find(":input:not([_disabled])").attr("disabled",true);$.ajax({type:"POST",dataType:"json",data:b,url:a.attr("action"),success:function(d){TOP.showMessage(d.message,5000,d.success?"success":null);a.find(":input:not([_disabled])").attr("disabled",false);location="/app/attend/schedule/index"},error:function(d){TOP.showMessage(TOP.TEXT.PROCESSING_ERROR);a.find(":input:not([_disabled])").attr("disabled",false)}})},setSchedules:function(a){this._schedules=a},setUserPlans:function(a){this._plans=a},save:function(f){if(!$('input[name="user[]"]').size()){return TOP.showMessage(this._lang.missing_users)}var k=$("#grid-data");var a=this.grid.getConfig("cell");var i=$('input[name="type"]:checked').val();k.find("input").remove();k.append('<input name="valuenum" type="hidden" value="'+a+'" />');var j=this.grid.getGridData();for(var m in j){for(var l in j[m]){var d=j[m][l];var e="^off";var h=$('input[_user="u-'+d.user+'"]').val();if(typeof d.scid!="undefined"&&d.scid!=""){e=d.scid;if(!e){e="^off"}}c=parseInt(l)+1;if(i==0&&c%7==0){c=c-7}k.append('<input name="value-'+h+"-"+c+'" type="hidden" value="'+e+'" />')}}var b=$("#theform");var g=b.serializeArray();$.ajax({type:"POST",dataType:"json",data:g,url:b.attr("action"),success:function(n){TOP.showMessage(n.message,5000,n.success?"success":null);if(n.success){if(f){location="/app/attend/schedule/plan"}else{location="/app/attend/schedule/user"}}},error:function(n){TOP.showMessage(TOP.TEXT.PROCESSING_ERROR)}})},updateScheduleColor:function(b,a){if(typeof this._schedules[b]!="undefined"){this._schedules[b].color=a}},refreshScheduleList:function(d){var e=this,a=$("#schedule-list");if(typeof d!="undefined"&&d.length>0){a.empty();this._currSchedules=new Array();for(var b=0,g=d.length;b<g;b++){if(typeof this._schedules[d[b]]!="undefined"){var f=this._schedules[d[b]];if(f.scheduleId!="^root"){a.append('<a _scid="'+f.scheduleId+'" href="javascript:void(0)" title="'+f.title+'"><span class="color_grid" style="background:'+f.color+'"></span><span>'+f.name+"</span></a>");this._currSchedules.push(f.scheduleId);a.find('a[_scid="'+f.scheduleId+'"] span.color_grid').bind("click",function(h){e.selectColor(this,true,function(j,i){e.updateScheduleColor(j,i);if(e.grid){e.grid.updateSchedules(this._schedules);e.grid.updateGridColor(j,i)}});TOP.stopEventBuddle(h)})}}}a.find("a").each(function(){$(this).bind("click",function(){var h=$(this).attr("_scid");e._currSelectScid=h;e.grid.setCurrentSchedule(h)})})}e.saveGrid();this.initGrid($('input[name="type"]:checked').val(),$("#plan-table tr.sc-tr").size(),$("#cyclenum").val());e.restoreGrid();if(e._plans.length>0){e.selectGridTd(e._plans)}},refreshGrid:function(e){var l=$("#plan-table"),d=[],j=this,k=$('input[name="type"]:checked').val();if(k==1){var b=[],a=[];$('input[name^="user-"]').each(function(){b.push(this.value)})}this.saveGrid();l.find("tr.sc-tr").remove();this._gridUsers=[];for(var f=0;f<e.length;f++){var h=e[f];if(h.groupid){d.push(h.groupid)}else{if(k==1&&!TOP.Util.inArray(h.email,b)){a.push(h.email)}this.appendGridUsers(l,f,h.email,h.name)}}if(d.length>0){this.getGroupUsers(d,function(i){if(i.success&&i.data){var m=i.data;TOP.Cast.load(function(){var p=TOP.Cast.get("users");for(var r in m){for(var q=0,o=p.length;q<o;q++){if(!TOP.Util.inArray(m[r].email,j._gridUsers)&&p[q].uniqueid==m[r].uniqueid){if(k==1&&!TOP.Util.inArray(m[r].email,b)){a.push(m[r].email)}j.appendGridUsers(l,q,m[r].email,m[r].truename)}}}var n=j._gridUsers.length;$("#grid-ct").attr("rowspan",n+1);j.initGrid(k,n,$("#cyclenum").val());j.restoreGrid();if(k==1&&a.length>0){j.loadUserPlans(a,function(s){if(s.success&&s.data){j.chooseGridTd(s.data)}})}})}})}else{var g=this._gridUsers.length;$("#grid-ct").attr("rowspan",g+1);this.initGrid(k,g,$("#cyclenum").val());this.restoreGrid();if(k==1&&a.length>0){j.loadUserPlans(a,function(i){if(i.success&&i.data){j.chooseGridTd(i.data)}})}}},chooseGridTd:function(h){if(!this.grid){return}var i=$("#plan-table"),a=[];for(var f in h){var j=i.find('.sc-td[_uid="'+f+'"]').parent().prevAll().length-1,d=h[f];for(var e in d){if(typeof this._schedules[d[e]]!="undefined"){var b=this._schedules[d[e]].scheduleId,g=parseInt(e)-1;this.grid.select(j,g,b,f);if(!TOP.Util.inArray(d[e],a)){a.push(d[e])}}}}$("#schedule-list a").each(function(){var k=$(this).attr("_scid");if(!TOP.Util.inArray(k,a)){a.push(k)}});if(a.length>0){this.refreshScheduleList(a)}},loadUserPlans:function(f,g){var d=this;var b=$("#year").val(),e=$("#month").val(),a="/app/attend/schedule/loadplans?email="+f.join(",");a+="&year="+b+"&month="+e;$.ajax({type:"GET",dataType:"json",url:a,success:function(h){if(typeof g=="function"){g.call(d,h)}},error:function(h){TOP.showMessage("\u52a0\u8f7d\u7528\u6237\u6392\u73ed\u8ba1\u5212\u5931\u8d25")}})},setGridUsers:function(a){var d=this,b=$("#plan-table");b.find("tr.sc-tr").remove();this._gridUsers=[];TOP.Cast.load(function(){var k=TOP.Cast.get("users");for(var j=0,g=k.length;j<g;j++){if(TOP.Util.inArray(k[j].uniqueid,a)){var h='<span title="'+k[j].truename+"&lt;"+k[j].username+'&gt;">'+k[j].truename+"</span>";b.append('<tr class="sc-tr"><td align="right" class="td-cp sc-td" _uid="'+k[j].username+'" _unid="'+k[j].uniqueid+'"><label for="u-'+j+'"><input type="hidden" name="user-'+j+'" value="'+k[j].username+'" /><input type="hidden" name="user[]" value="'+j+'" /><input _user="u-'+k[j].username+'" id="u-'+j+'" type="checkbox" name="member[]" value="'+j+'" />'+h+"</label></td></tr>");d._gridUsers.push(k[j].username)}}var f=d._gridUsers.length;$("#grid-ct").attr("rowspan",f+1);var e=[];if(d._plans.length>0){e=d.getSelectScids()}d.refreshScheduleList(e)})},appendGridUsers:function(e,f,b,a){var d='<span title="'+a+"&lt;"+b+'&gt;">'+a+"</span>";e.append('<tr class="sc-tr"><td align="right" class="td-cp sc-td" _uid="'+b+'"><label for="u-'+f+'"><input type="hidden" name="user-'+f+'" value="'+b+'" /><input type="hidden" name="user[]" value="'+f+'" /><input _user="u-'+b+'" id="u-'+f+'" type="checkbox" name="member[]" value="'+f+'" />'+d+"</label></td></tr>");this._gridUsers.push(b)},getGroupUsers:function(a,d){var b=this;$.ajax({type:"GET",dataType:"json",url:"/app/attend/schedule/getgroupusers?groupid="+a.join(","),success:function(e){if(typeof d=="function"){d.call(b,e)}},error:function(e){TOP.showMessage("\u52a0\u8f7d\u7fa4\u7ec4\u7528\u6237\u5931\u8d25")}})},saveGrid:function(){if(!this.grid){return}this._gridData=this.grid.getGridData()},restoreGrid:function(){if(!this.grid||this._gridData===null){return}if(this._gridData){for(var e in this._gridData){for(var a in this._gridData[e]){var b=this._gridData[e][a];if(typeof b.scid!="undefined"&&b.scid!=""){if(this._currSchedules&&!TOP.Util.inArray(b.scid,this._currSchedules)){continue}if(this._gridUsers.length>0&&!TOP.Util.inArray(b.user,this._gridUsers)){continue}else{if(this._gridUsers.length>0&&TOP.Util.inArray(b.user,this._gridUsers)){for(var d=0;d<this._gridUsers.length;d++){if(b.user==this._gridUsers[d]){b.row=d}}}}this.grid.select(b.row,a,b.scid,b.user)}}}this._gridData=[]}if(this._gridUsers){this._gridUsers=[]}},selectGridTd:function(){if(!this.grid||this._plans.length<=0){return}var m=$("#plan-table"),k=this._plans;for(var b=0;b<k.length;b++){var f=k[b];for(var d in f){var n=m.find('.sc-td[_unid="'+d+'"]').parent().prevAll().length-1,g=m.find('.sc-td[_unid="'+d+'"]').attr("_uid");for(var a=0;a<f[d].length;a++){var l=f[d][a];if(typeof this._schedules[l.scid]!="undefined"){var e=this._schedules[l.scid].scheduleId,h=parseInt(l.day)-1;this.grid.select(n,h,e,g)}}}}this._plans=[]},initGrid:function(n,o,s){var e=null,a=[],p=[],m=this;if(n=="week"||n==0){e=this._lang.weekdays;for(var d=0,b=s;d<b;d++){a=a.concat(e);p.push(5+d*7);p.push(6+d*7)}}else{var k=$("#year").val(),j=parseInt($("#month").val());var r=new Date();r.setFullYear(k,j,0);var q=r.getDate();for(var d=0;d<q;d++){a[a.length]=d+1;r.setDate(d+1);var h=r.getDay();if(h==0||h==6){p.push(d)}}}$("#schedule-grid").empty();this.grid=new SelectGrid({id:"plan-grid",cls:"timegrid",row:o,cell:a.length,colHeader:a,rowMultiSelect:true,draggable:true,schedules:m._schedules});this.grid.appendTo("#schedule-grid");var f=$("#plan-grid");for(var d=0,b=p.length;d<b;d++){f.find("tr").each(function(){$(this).find("td:eq("+p[d]+")").addClass("grid-weekend")})}if(m._currSelectScid){m.grid.setCurrentSchedule(m._currSelectScid)}},setUsers:function(a){if(!a||a.length<=0){return}this.uniqueIds=a},setDepts:function(a){if(!a||a.length<=0){return}this.deptIds=a},userSelectWin:function(h,b){if(!h){h=false}if(!b){b=false}var f='<div class="pop pop_linkman"><div class="pop_header"><strong>'+TOP.TEXT.SELECT_CONTACT+'</strong><a class="icon icon_close close"></a></div><div class="pop_body"></div><div class="pop_footer"><button type="button" name="confirm" class="btn">'+TOP.TEXT.CONFIRM+'</button><button type="button" class="btn close">'+TOP.TEXT.CANCEL+"</button></div></div>";var e=TOP.Frame.TempWindow;e.append(f,{width:470,draggalbe:true,onShow:function(){e.center()},onClose:function(){e.destroy()}});var g=[];if(b){var d=$("#user-box");$('input:hidden[name="user[]"]').each(function(){g.push({_id:this.value})})}else{$('input[name="user[]"]').each(function(){var i=$('input[name="user-'+this.value+'"]').val();g.push({_id:i})})}var a=new TOP.ContactSelector({appendTo:e.find("div.pop_body"),enableGroup:h,selected:g,panels:["common"],childOf:this.deptIds});e.show();e.find('button[name="confirm"]').bind("click",function(){var n=a.getSelected();if(b){d.empty();for(var m=0,j=n.length;m<j;m++){var o=n[m];var p=o.groupid?o.groupid:o.email,k=o.groupid?TOP.TEXT.GROUP:o.email;d.append('<p><input type="hidden" name="user[]" value="'+p+'" />'+o.name+'<span class="gray">&lt;'+k+"&gt;</span></p>")}}else{Attend.Plan.refreshGrid(n)}e.close()})},initList:function(a){TOP.keyhint("#keyword","gray",true,document.body);$("#user-list tr").mousemove(function(){$(this).addClass("current")}).mouseout(function(){$(this).removeClass("current")});$('button[name="modify"]').bind("click",function(){var d=[];$('input[name="uniqueid"]').each(function(){if(this.checked){d.push(this.value)}});url="/app/attend/schedule/plan?back="+a;if(d.length){url+="&uniqueid="+d.join(",");var b=$("#year").val(),e=$("#month").val();url+="&year="+b+"&month="+e}location.assign(url)})}};var SelectGrid=function(a){this._cfg=$.extend({},SelectGrid.defaultConfig,a);this._initTable()};SelectGrid.defaultConfig={row:7,cell:24,cls:"",rowHeaderWidth:36,rowHeader:null,colHeader:null,rowMultiSelect:true,colMultiSelect:true,draggable:true};SelectGrid.prototype={_gridData:null,_cfg:null,_table:null,_start:null,_startHeader:null,_enabled:true,_currentSchedule:null,_initTable:function(){var p=this._cfg.row,u=this._cfg.cell;this._gridData=new Array();this._table=document.createElement("table");this._table.className=this._cfg.cls,this._table.cellPadding=0,this._table.cellSpacing=0,this._table.border=0,this._table.onselectstart=function(){return false};if(this._cfg.id){this._table.id=this._cfg.id}if(!this._cfg.rowHeader){u--}if(!this._cfg.colHeader){p--}for(var s=0;s<=p;s++){this._gridData[s]=new Array();var a=this._table.insertRow(s);if(s==p){a.className+=" last"}if(s==0){a.className+=" timegrid-time"}for(var q=0;q<=u;q++){var o=((this._cfg.colHeader&&s==0)||(this._cfg.rowHeader&&q==0)),b=(o?document.createElement("th"):document.createElement("td"));a.appendChild(b);if(o){if(s==0){if(!this._cfg.rowHeader||(this._cfg.colHeader&&undefined!=this._cfg.colHeader[q-1])){var l=this._cfg.rowHeader?q-1:q;b.innerHTML="<div>"+this._cfg.colHeader[l]+"</div>";b._cell=l}else{b.innerHTML='<div align="right"><span class="time-angle"></span></div>'}}else{if(this._cfg.rowHeader&&undefined!=this._cfg.rowHeader[s-1]){var l=this._cfg.colHeader?s-1:s;b.innerHTML="<div>"+this._cfg.rowHeader[l]+"</div>";b._row=l}}if(q==0&&this._cfg.rowHeader&&this._cfg.colHeader){b.width=this._cfg.rowHeaderWidth}}else{b._row=this._cfg.colHeader?s-1:s;b._cell=this._cfg.rowHeader?q-1:q;var e=document.createElement("div");var d=document.createElement("div");e.style.cssText="display:none;";e.className="over";d.style.cssText="display:block;";d.className="select";d.setAttribute("_scid","");b.appendChild(e);b.appendChild(d);var t=$('input[name="user[]"]:eq('+b._row+")").val();var n=$('input[name="user-'+t+'"]').val();this._gridData[b._row][b._cell]={row:b._row,user:n,scid:""}}if(q==u){b.className="last"}}}var m=$(this._table).find("td"),h=this._cfg.rowHeader?$(this._table).find("tr:eq(0) th:not(:eq(0))"):$(this._table).find("tr:eq(0) th"),g=$(this._table).find("tr:not(:eq(0)) th");var v=this,k=this._cfg;m.bind("mousedown",function(){if(!v._enabled){return}if(!v.checkCurrentSchedule()||!v.checkHasUsers()){return}var z=$(this),w=z.hasClass("enable");v._start={row:z.attr("_row"),cell:z.attr("_cell"),enable:!z.hasClass("enable"),scheduleId:z.find("div.select").attr("_scid")};if(!k.rowMultiSelect){v.unselectColumn(v._start.cell)}if(!k.colMultiSelect){v.unselectRow(v._start.row)}var A=v.getCurrentSchedule();var E=z.parent("tr").prevAll().length-1;var C=z.prevAll().length;var j=$('input[name="user[]"]:eq('+E+")").val();var B=$('input[name="user-'+j+'"]').val();if(z.find("div.select").attr("_scid")!=A.scheduleId){w=false;v._start.enable=true}if(w){z.removeClass("enable");z.find("div.select").attr("_scid","").css({background:""});v._gridData[E][C]={row:E,user:B,scid:""}}else{z.addClass("enable");z.find("div.select").attr("_scid",A.scheduleId).css({background:A.color});v._gridData[E][C]={row:E,user:B,scid:A.scheduleId}}if(v.isBatch()){var y=v.getBatchRow();if(TOP.Util.inArray(E,y)){var D=$(v._table);for(var x=0;x<y.length;x++){var r=D.find("tr:eq("+(y[x]+1)+") td:eq("+C+")"),j=$('input[name="user[]"]:eq('+y[x]+")").val(),B=$('input[name="user-'+j+'"]').val();if(w){r.removeClass("enable");r.find("div.select").attr("_scid","").css({background:""});v._gridData[y[x]][C]={row:y[x],user:B,scid:""}}else{r.addClass("enable");r.find("div.select").attr("_scid",A.scheduleId).css({background:A.color});v._gridData[y[x]][C]={row:y[x],user:B,scid:A.scheduleId}}}}}});m.bind("mouseover",function(){if(!v._start){$(this).addClass("over");$(this).find("div.over").show();$(this).find("div.select").hide();return false}if(!v.checkCurrentSchedule()||!v.checkHasUsers()){return}if(k.draggable){var N=$(this),M=$(v._table),A=N.attr("_row"),y=N.attr("_cell");var z=Math.min(v._start.row,A)+1,J=Math.max(v._start.row,A)+1,E=Math.min(v._start.cell,y),H=Math.max(v._start.cell,y);M.find("td div.select").removeClass("enable");M.find("td div.select").removeClass("disable");var G,O;var x=v._start.enable?"enable":"disable";var j=v.getCurrentSchedule();var I=v._start.enable?j.scheduleId:"";for(G=z;G<=J;G++){var C=M.find("tr:eq("+G+")"),L=$('input[name="user[]"]:eq('+(G-1)+")").val(),D=$('input[name="user-'+L+'"]').val();isChecked=$('input[name="member[]"]:eq('+(G-1)+")").is(":checked");for(O=E;O<=H;O++){C.find("td:eq("+O+") div.select").addClass(x).attr("_scid",I).css({background:color});v._gridData[G-1][O]={row:G-1,user:D,scid:I};if(isChecked){var F=v.getBatchRow();var M=$(v._table);for(var K=0;K<F.length;K++){var B=M.find("tr:eq("+(F[K]+1)+") td:eq("+O+")"),w=$('input[name="user[]"]:eq('+F[K]+")").val(),P=$('input[name="user-'+w+'"]').val();B.find("div.select").addClass(x).attr("_scid",I).css({background:color});v._gridData[F[K]][O]={row:F[K],user:P,scid:I}}}}}}}).bind("mouseout",function(){$(this).removeClass("over");$(this).find("div.over").hide();$(this).find("div.select").show()});if(this._cfg.colHeader&&this._cfg.rowHeader){$(this._table).find("tr:eq(0) th:eq(0)").bind("mouseover",function(){$(this).addClass("over")}).bind("mouseout",function(){$(this).removeClass("over")}).bind("click",function(){v.selectAll();v.onChange()})}if(this._cfg.colHeader&&this._cfg.rowMultiSelect){h.each(function(r){var w=$(this),j=w.attr("_cell");w.bind("mousedown",function(){if(!v.checkCurrentSchedule()||!v.checkHasUsers()){return}var i=v.selectColumn(r);v._startHeader={type:"col",index:j,enable:i}}).bind("mouseover",function(){w.addClass("over");var F=$(v._table);F.find("td div.select").removeClass("enable");F.find("td div.select").removeClass("disable");if(v._startHeader&&v._startHeader.type=="col"){var G=Math.max(v._startHeader.index,j),E=Math.min(v._startHeader.index,j);var H=v._startHeader.enable?"enable":"disable";var B=v.getCurrentSchedule();var C=v._startHeader.enable?B.scheduleId:"";for(var z=1,A=v._cfg.row;z<=A;z++){var x=$('input[name="user[]"]:eq('+(z-1)+")").val(),D=$('input[name="user-'+x+'"]').val();for(var y=E;y<=G;y++){F.find("tr:eq("+z+") td:eq("+y+") div.select").addClass(H).attr("_scid",C).css({background:color});v._gridData[z-1][y]={row:z-1,user:D,scid:C}}}}}).bind("mouseout",function(){w.removeClass("over")})})}if(this._cfg.rowHeader&&this._cfg.colMultiSelect){g.each(function(j){var x=$(this),r=x.parent(),w=x.attr("_row");x.bind("mousedown",function(){if(!v.checkCurrentSchedule()||!v.checkHasUsers()){return}var i=v.selectRow(j);v._startHeader={type:"row",index:w,enable:i}}).bind("mouseover",function(){x.addClass("over");r.find("td").addClass("over");var H=$(v._table);H.find("td div.select").removeClass("enable");H.find("td div.select").removeClass("disable");if(v._startHeader&&v._startHeader.type=="row"){var F=Math.max(v._startHeader.index,w)+1,B=Math.min(v._startHeader.index,w)+1;var I=v._startHeader.enable?"enable":"disable";var D=v.getCurrentSchedule();var E=v._startHeader.enable?D.scheduleId:"";for(var A=B;A<=F;A++){var y=$('input[name="user[]"]:eq('+(A-1)+")").val(),G=$('input[name="user-'+y+'"]').val();for(var z=0,C=v._cfg.cell;z<C;z++){H.find("tr:eq("+A+") td:eq("+z+") div.select").addClass(I).attr("_scid",E).css({background:color});v._gridData[A-1][z]={row:A-1,user:G,scid:E}}}}}).bind("mouseout",function(){x.removeClass("over");r.find("td").removeClass("over")})})}$(window).bind("mouseup",f);$(document.body).bind("mouseup",f);function f(){var j=v._start!=null||v._startHeader!=null,i=$(v._table);v._start=null;v._startHeader=null;var r=v.getCurrentSchedule();i.find("td div.enable").each(function(){$(this).parent("td").addClass("enable");$(this).attr("_scid",r.scheduleId).css({background:r.color})});i.find("td div.disable").each(function(){$(this).parent("td").removeClass("enable");$(this).attr("_scid","").css({background:""})});i.find("td div.select").removeClass("enable");i.find("td div.select").removeClass("disable");if(j){v.onChange()}}},setCurrentSchedule:function(b){var a=this._cfg.schedules;this._currentSchedule=a[b]},getCurrentSchedule:function(){return this._currentSchedule},checkCurrentSchedule:function(){if(!this._currentSchedule){if(!$("#schedule-list a").size()){TOP.showMessage("\u8bf7\u5148\u6dfb\u52a0\u6392\u73ed\u65b9\u6848",5000)}else{TOP.showMessage("\u8bf7\u9009\u62e9\u6392\u73ed\u65b9\u6848",5000)}return false}return true},checkHasUsers:function(){if(!$('input[name="user[]"]').size()){TOP.showMessage("\u8bf7\u6dfb\u52a0\u4eba\u5458",5000);return false}return true},onChange:function(){if(typeof this._cfg.onChange=="function"){this._cfg.onChange.call(this)}},getConfig:function(a){return this._cfg[a]},getGridData:function(){return this._gridData},eachRow:function(d){if(typeof(d)!="function"){return}var a=0,b=this;$(this._table).find("tr:gt(0)").each(function(){d.call(b,a);a++})},getRowSelected:function(b){var a=[];$(this._table).find("tr:eq("+(b+1)+") td.enable").each(function(){a.push($(this).attr("_cell"))});return a},getColumnSelected:function(b){var a=[];$(this._table).find("tr:gt(0)").each(function(e){var h=$(this);if(h.find("td:eq("+b+")").hasClass("enable")){var f=h.find("td:eq("+b+") div.select").attr("_scid"),d=$('input[name="user[]"]:eq('+e+")").val(),g=$('input[name="user-'+d+'"]').val();a.push({row:e,user:g,scid:f})}});return a},updateSchedules:function(a){if(typeof a!="undefined"){this._cfg.schedules=a}},updateGridColor:function(b,a){$(this._table).find('td div.select[_scid="'+b+'"]').css({background:a})},select:function(i,b,g,h){var d=$(this._table).find("tr:eq("+(i+1)+") td:eq("+b+")"),f=this._cfg.schedules,e=f[g].color;d.addClass("enable");d.find("div.select").attr("_scid",g).css({background:e});this._gridData[i][b]={row:i,user:h,scid:g}},selectAll:function(){if(this.isAll()){$(this._table).find("td").removeClass("enable");$(this._table).find("td div.select").attr("_scid","").css({background:""})}else{var a=this.getCurrentSchedule();$(this._table).find("td").addClass("enable");$(this._table).find("td div.select").attr("_scid",a.scheduleId).css({background:a.color})}},isAll:function(){for(var a=0;a<this._cfg.row;a++){if(this.getRowSelected(a).length<this._cfg.cell){return false}}return true},isBatch:function(){var a=false;if($('input:checked[name="member[]"]').size()>1){a=true}return a},getBatchRow:function(){var a=[];$('input[name="member[]"]').each(function(b){if($(this).is(":checked")){a.push(b)}});return a},clearSelect:function(){$(this._table).find("td").removeClass("enable");$(this._table).find("td div.select").attr("_scid","").css({background:""})},selectRow:function(b){var a=this.getRowSelected(b).length!=this._cfg.cell;if(!a){$(this._table).find("tr:eq("+(b+1)+") td").removeClass("enable");$(this._table).find("tr:eq("+(b+1)+") td div.select").attr("_scid","").css({background:""})}else{var d=this.getCurrentSchedule();$(this._table).find("tr:eq("+(b+1)+") td").addClass("enable");$(this._table).find("tr:eq("+(b+1)+") td div.select").attr("_scid",d.scheduleId).css({background:d.color})}return a},unselectRow:function(a){$(this._table).find("tr:eq("+(a+1)+") td").removeClass("enable");$(this._table).find("tr:eq("+(a+1)+") td div.select").attr("_scid","").css({background:""})},selectColumn:function(b){var d=this,a=this.getColumnSelected(b).length!=this._cfg.row,e=d.getCurrentSchedule();if(!a){if($(this._table).find("tr td:eq("+b+") div.select").attr("_scid")!=e.scheduleId){a=true}}$(this._table).find("tr").each(function(g){var i=$(this).find("td:eq("+b+")");if($(this).find("td").size()){var f=$('input[name="user[]"]:eq('+(g-1)+")").val(),h=$('input[name="user-'+f+'"]').val();if(a){i.addClass("enable");i.find("div.select").attr("_scid",e.scheduleId).css({background:e.color});d._gridData[g][b]={row:g,user:h,scid:e.scheduleId}}else{i.removeClass("enable");i.find("div.select").attr("_scid","").css({background:""});d._gridData[g][b]={row:g,user:h,scid:""}}}});return a},unselectColumn:function(a){$(this._table).find("tr").each(function(){$(this).find("td:eq("+a+")").removeClass("enable");$(this).find("td:eq("+a+") div.select").attr("_scid","").css({background:""})})},enabled:function(){this._enabled=true},disabled:function(){this._enabled=false;this._start=false},appendTo:function(a){$(a).append(this._table)}};
