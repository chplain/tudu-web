OTR.Graph={_adapterTypes:["canvas","vml","svg"],factory:function(b,a){if(typeof b!=="object"){throw"Invalid params for OTR.Graph Adapter to create";return null}a=(undefined!==a&&this._isSupported(a))?a:this._adapterType();a=a.substring(0,1).toUpperCase()+a.substring(1);return new OTR.Graph[a](b)},_adapterType:function(){var a=document.createElement("canvas");if(undefined!==a.getContext){return"canvas"}else{if(OTR.Client.browser(OTR.Client.MSIE)){return"vml"}}return"svg"},_isSupported:function(b){if(typeof b!=="string"){return}b=b.toLowerCase();var d=this._adapterTypes,e=d.length,a=0;for(;a<e;a++){if(d[a]==b){return true}}return false}};(function(){var a=OTR.Graph;a.Brush=function(b,c){if(!b instanceof OTR.Graph.Adapter||!c instanceof OTR.Graph.Shape){return}this._adapter=b;this._shape=c};a.Brush.prototype={draw:function(){},parseColor:function(b,c){}}})();OTR.Graph.Color=function(a){this._attrs={x:0,y:0,dx:100,dy:0,colors:[],type:"linear"};this.setAttrs(a)};OTR.Graph.Color.prototype={attr:function(a,b){if(undefined===b){if(typeof(a)=="object"){this.setAttrs(a);return this}return this.getAttr(a)}else{if(undefined!==this._attrs[a]){this._attrs[a]=b}return this}},getAttr:function(a){if(undefined!==this._attrs[a]){return this._attrs[a]}return null},setAttrs:function(b){if(!OTR.Util.isObject(b)){return this}for(var a in b){if(undefined!==this._attrs[a]){if(a=="colors"){this.setColors(b[a]);continue}this._attrs[a]=b[a]}}return this},setColors:function(b){if(OTR.Util.isArray(b)){for(var d=0,a=b.length;d<a;d++){var c=b[d];if(OTR.Util.isArray(c)){if(c.length<2){continue}this.addColor(c[0],c[1])}else{if(OTR.Util.isObject(c)){if(undefined===c.offset||!c.color){continue}this.addColor(c.offset,c.color)}}}}return this},addColor:function(b,a){this._attrs.colors.push({offset:b,color:a});return this}};
OTR.Graph.Shape=function(a){this._attrs={x:0,y:0,width:0,height:0,borderWidth:0,borderColor:"#000000",background:"#ffffff"};this._init(a)};OTR.Graph.Shape.prototype={_init:function(a){this.setAttrs(a)},attr:function(a,b){if(undefined===b){if(typeof(a)=="object"){this.setAttrs(a);return this}return this.getAttr(a)}else{if(undefined!==this._attrs[a]){this._attrs[a]=b}return this}},getAttr:function(a){if(undefined!==this._attrs[a]){return this._attrs[a]}return null},setAttrs:function(b){for(var a in b){if(undefined!==this._attrs[a]){this._attrs[a]=b[a]}}return this},getName:function(){return this.__name},_addAttrs:function(b){if(typeof b=="string"){this._attrs[b]=null}else{if(OTR.Util.isObject(b)){for(var a in b){this._attrs[a]=b[a]}}}},_setName:function(a){if(!OTR.Util.isString(a)){throw"name must be a string"}this.__name=a}};OTR.Graph.Rect=OTR.extend(OTR.Graph.Shape,{_init:function(a){this._addAttrs({borderRadius:0});this._setName("Rect");OTR.Graph.Rect.__super._init.call(this,a)}});OTR.Graph.Cycle=OTR.extend(OTR.Graph.Shape,{_init:function(a){this._setName("Cycle");OTR.Graph.Rect.__super._init.call(this,a)}});OTR.Graph.Line=OTR.extend(OTR.Graph.Shape,{_init:function(a){this._addAttrs({dy:0,dx:0,endArrow:null,startArrow:null});this._setName("Line");OTR.Graph.Rect.__super._init.call(this,a)}});OTR.Graph.PolyLine=OTR.extend(OTR.Graph.Shape,{_init:function(a){this._addAttrs({points:[],endArrow:null,startArrow:null});this._setName("PolyLine");OTR.Graph.Rect.__super._init.call(this,a)},setAttrs:function(b){for(var a in b){if(undefined===this._attrs[a]){continue}switch(a){case"points":this.setPoints(b[a]);break;default:this._attrs[a]=b[a];break}}},setPoints:function(d){if(!OTR.Util.isArray(d)||d.length<3){throw"invalid point list"}var b=0,a=d.length,c=[];for(;b<a;b++){var e=d[b];if(OTR.Util.isArray(e)){if(e.length>=2){c.push({x:e[0],y:e[1]})}}else{if(OTR.Util.isObject(e)){if(undefined!==e.x&&undefined!==e.y){c.push({x:e.x,y:e.y})}}}}this._attrs.points=c}});OTR.Graph.Polygon=OTR.extend(OTR.Graph.Shape,{_init:function(a){this._addAttrs({points:null,sideCount:3,rotate:0});this._setName("Polygon");OTR.Graph.Rect.__super._init.call(this,a)},setAttrs:function(b){for(var a in b){if(undefined===this._attrs[a]){continue}switch(a){case"points":this.setPoints(b[a]);break;default:this._attrs[a]=b[a];break}}},setPoints:function(d){if(!OTR.Util.isArray(d)||d.length<3){throw"invalid point list"}var b=0,a=d.length,c=[];for(;b<a;b++){var e=d[b];if(OTR.Util.isObject(e)){if(undefined!==e.x&&undefined!==e.y){c.push({x:e.x,y:e.y})}}else{if(OTR.Util.isArray(e)){if(e.length>=2){c.push({x:e[0],y:e[1]})}}}}this._attrs.points=c},getPoints:function(){if(!this._attrs.points&&this._attrs.sideCount>2){var e=[],f=0,h=this._attrs.sideCount,k=Math.max(this._attrs.width,this._attrs.height),b=k/2,c=Math.PI*2,g=this._attrs.rotate,j=this._attrs.width/k,l=this._attrs.height/k,a={x:this._attrs.x+b*j,y:this._attrs.y+b*l};for(;f<h;f++){e.push({x:a.x+(b*Math.sin(f/h*c+this._angelToRadian(g)))*j,y:a.y+(b*Math.cos(f/h*c+this._angelToRadian(g)))*l})}this._attrs.points=e}return this._attrs.points},_angelToRadian:function(a){return a/180*Math.PI}});OTR.Graph.Text=OTR.extend(OTR.Graph.Shape,{_init:function(d){this._addAttrs({text:"",fontFamily:"Arial",fontSize:"12px",color:"#000000",textAlign:"start",borderWeight:0,baseLine:"top",maxWidth:0});this._setName("Text");OTR.Graph.Rect.__super._init.call(this,d);var b=this._attrs,c=parseInt(b.fontSize);b.width=Math.min(c*b.text.length,b.maxWidth);b.height=c}});OTR.Graph.Cycle=OTR.extend(OTR.Graph.Shape,{_init:function(a){this._setName("Image");this._addAttrs({src:""});OTR.Graph.Rect.__super._init.call(this,a)}});
OTR.Graph.Adapter=function(a){this.init(a)};OTR.Graph.Adapter.prototype={_rendered:false,_type:null,renderTo:function(a){if(this._canvas){a.appendChild(this._canvas)}this._rendered=true;return this},isRendered:function(){return this._rendered},init:function(a){},drawShape:function(b){if(!b instanceof OTR.Graph.Shape){return this}var a=new OTR.Graph[this._type][b.getName()](this,b);a.draw();return this},getCanvas:function(){return this._canvas},_setType:function(a){this._type=a}};OTR.Graph.Canvas=OTR.extend(OTR.Graph.Adapter,{init:function(c){if(!OTR.Util.isObject(c)){}this._setType("Canvas");this._cfgs={width:100,height:100,doc:document};for(var a in c){this._cfgs[a]=c[a]}var b=this._cfgs.doc.createElement("canvas");b.width=this._cfgs.width;b.height=this._cfgs.height;if(undefined!=this._cfgs.id){b.id=this._cfgs.id}this._canvas=b},getContext:function(a){if(undefined==a){a="2d"}if(undefined==this._context){this._context=this._canvas.getContext(a);this._context.lineJoin="round"}return this._context}});(function(){var b=OTR.Graph.Canvas;b.Brush=OTR.extend(OTR.Graph.Brush,{parseColor:function(l,m){var e=l.attr(m);if(OTR.Util.isString(e)){return e}if(e instanceof OTR.Graph.Color){var m=e.attr("type"),c=e.attr("colors"),j=this._adapter.getContext(),h;if(c.length<=0){return"#000000"}if(m=="linear"){var q=l.attr("x"),o=l.attr("y"),p=e.attr("x"),n=e.attr("y"),t=e.attr("dx"),s=e.attr("dy"),h=j.createLinearGradient(q+p,o+n,q+t,o+s)}else{if(m=="radia"){var q=l.attr("x"),o=l.attr("y"),a=Math.max(l.attr("width"),l.attr("height"));sX=e.attr("x"),sY=e.attr("y"),h=j.createRadialGradient(q+sX,o+sY,(a/c.length),q+sX,o+sY,a)}else{return c[0].color}}for(var f=0,d=c.length;f<d;f++){h.addColorStop(c[f].offset,c[f].color)}return h}return"#000000"}});b.Rect=OTR.extend(b.Brush,{draw:function(){var d=this._adapter.getContext(),k=this._shape;var j=k.attr("borderRadius");d.save();d.fillStyle=this.parseColor(k,"background");d.strokeStyle=this.parseColor(k,"borderColor");d.lineWidth=k.attr("borderWidth");var g=k.attr("x")-0.5,f=k.attr("y")-0.5,i=k.attr("width"),c=k.attr("height");d.beginPath();var a=g+i,e=f+c;d.moveTo(g+j,f);d.lineTo(a-j,f);d.arc(a-j,f+j,j,3*Math.PI/2,2*Math.PI,false);d.lineTo(a,e-j);d.arc(a-j,e-j,j,0,Math.PI/2,false);d.lineTo(g+j,e);d.arc(g+j,e-j,j,Math.PI/2,Math.PI,false);d.arc(g+j,f+j,j,Math.PI,3*Math.PI/2,false);d.stroke();d.fill();d.closePath();d.restore()}});b.Cycle=OTR.extend(b.Brush,{draw:function(){var g=this._shape,e=this._adapter.getContext(),c=g.attr("width"),f=g.attr("height"),j=Math.max(c,f),a=g.attr("x"),k=g.attr("y");e.save();e.fillStyle=this.parseColor(g,"background");e.strokeStyle=this.parseColor(g,"borderColor");e.lineWidth=g.attr("borderWidth");e.beginPath();var i=[1,1];if(c!=f){i=c>f?[1,f/j]:[c/j,1]}e.scale(i[0],i[1]);e.arc((a+c/2)/i[0],(k+f/2)/i[1],j/2,0,Math.PI*2);e.fill();e.stroke();e.closePath();e.restore()}});b.Line=OTR.extend(b.Brush,{draw:function(){var k=this._shape,e=this._adapter.getContext(),d=k.attr("x")-0.5,c=k.attr("y")-0.5,l=k.attr("dx")-0.5,j=k.attr("dy")-0.5,h=k.attr("startArrow"),f=k.attr("endArrow"),i=k.attr("borderWidth");e.save();if(h||f){var g=l-d!=0?Math.atan((j-c)/(l-d)):Math.PI/2,a=(i+7)/2;if(h){d=d+Math.cos(g)*a;c=c+Math.sin(g)*a}if(f){l=l-Math.cos(g)*a;j=j-Math.sin(g)*a}}e.strokeStyle=this.parseColor(k,"borderColor");e.lineWidth=i;e.beginPath();e.moveTo(d,c);e.lineTo(l,j);e.stroke();e.closePath();e.restore();if(h){this._drawArrow(true,h)}if(f){this._drawArrow(false,f)}},_drawArrow:function(j,h){var g=this._shape,c,i=this._getArrowPos(j),e=this._getArrowRotate(j),d=this.parseColor(g,"borderColor"),f=g.attr("borderWidth")+7;switch(h){case"Cycle":c=new OTR.Graph.Cycle({borderColor:d,background:d,width:f,height:f,x:i.x-f/2,y:i.y-f/2});break;case"Block":default:c=new OTR.Graph.Polygon({borderColor:d,background:d,sideCount:3,width:f,height:f,x:i.x-f/2-1,y:i.y-f/2,rotate:e});break}this._adapter.drawShape(c)},_getArrowPos:function(i){var f=this._shape,h=(f.attr("borderWidth")+7)/2,g=f.attr("x")-0.5,e=f.attr("y")-0.5,d=f.attr("dx")-0.5,a=f.attr("dy")-0.5,c=Math.atan((a-e)/(d-g))/Math.PI*180;if(i){x=g+Math.cos(c)*h;y=e+Math.sin(c)*h}else{x=d-Math.cos(c)*h;y=a-Math.sin(c)*h}return{x:x,y:y}},_getArrowRotate:function(h){var e=this._shape,a=e.attr("x"),g=e.attr("y"),d=e.attr("dx"),c=e.attr("dy"),f;if(c-g==0){f=d>a?90:270}else{f=Math.atan((d-a)/(c-g))/Math.PI*180;if(d-a<0){f=f-180}}return f}});b.PolyLine=OTR.extend(b.Line,{draw:function(){var f=this._shape,d=this._adapter.getContext(),e=f.attr("points");if(!e||e.length<2){return}d.save();d.strokeStyle=this.parseColor(f,"borderColor");d.lineWidth=f.attr("borderWidth");d.beginPath();var c=0,a=e.length;for(;c<a;c++){if(c==0){d.moveTo(e[c].x-0.5,e[c].y-0.5);continue}d.lineTo(e[c].x-0.5,e[c].y-0.5)}d.stroke();d.closePath();d.restore();if(f.attr("startArrow")){this._drawArrow(true,f.attr("startArrow"))}if(f.attr("endArrow")){this._drawArrow(false,f.attr("endArrow"))}},_getArrowPos:function(c){var k=this._shape,a=(k.attr("borderWidth")+7)/2,j=k.attr("points"),d=j.length-1,h,i,g;if(c){h=Math.atan((j[1].y-j[0].y)/(j[1].x-j[0].x))/Math.PI*180;i=j[0].x+Math.cos(h)*a;g=j[0].y+Math.sin(h)*a}else{h=Math.atan((j[d].y-j[d-1].y)/(j[d].x-j[d-1].x))/Math.PI*180;var f=j[d].x-j[d-1].x>0?1:-1,e=j[d].x-j[d-1].x>0?1:-1;i=j[d].x-Math.cos(h)*a*f;g=j[d].y-Math.sin(h)*a*e}return{x:i,y:g}},_getArrowRotate:function(c){var i=this._shape,g=i.attr("points"),e=g.length,f=c?g[0].x:g[e-2].x,d=c?g[0].y:g[e-2].y,j=c?g[1].x:g[e-1].x,h=c?g[1].y:g[e-1].y,a;if(h-d==0){a=j>f?90:270}else{a=Math.atan((j-f)/(h-d))/Math.PI*180;if(j-f<0){a=a-180}}return a}});b.Polygon=OTR.extend(b.Brush,{draw:function(){var f=this._shape,d=this._adapter.getContext(),e=f.getPoints();if(!e||e.length<2){return}d.save();d.fillStyle=this.parseColor(f,"background");d.strokeStyle=this.parseColor(f,"borderColor");d.lineWidth=f.attr("borderWidth");d.beginPath();var c=0,a=e.length;for(;c<a;c++){if(c==0){d.moveTo(e[c].x-0.5,e[c].y-0.5);continue}d.lineTo(e[c].x-0.5,e[c].y-0.5)}d.lineTo(e[0].x-0.5,e[0].y-0.5);d.stroke();d.fill();d.closePath();d.restore()}});b.Text=OTR.extend(b.Brush,{draw:function(){var d=this._shape,c=this._adapter.getContext(),f=d.attr("text"),e=d.attr("lineWidth");c.save();c.strokeStyle=this.parseColor(d,"borderColor");c.lineWidth=e;c.font=d.attr("fontSize")+" "+d.attr("fontFamily");c.fillStyle=this.parseColor(d,"color");c.textBaseline=d.attr("baseLine");c.beginPath();var a=d.attr("x"),h=d.attr("y"),g=d.attr("maxWidth");if(!g){c.fillText(f,a,h);if(e>0){c.strokeText(f,a,h)}}else{c.fillText(f,a,h,g);if(e>0){c.strokeText(f,a,h,g)}}c.closePath();c.restore()}})})();OTR.Graph.Vml=OTR.extend(OTR.Graph.Adapter,{init:function(b){if(!OTR.Util.isObject(b)){}this._setType("Vml");this._ns="ortv";this._cfgs={width:100,height:100,doc:document};var d=["position:relative;display:block"];for(var a in b){if(undefined!==this._cfgs){this._cfgs[a]=b[a];if(a=="width"||a=="height"){d[d.length]=a+":"+b[a]+"px"}}}var e=this._cfgs.doc;e.namespaces.add(this._ns,"urn:schemas-microsoft-com:vml");if(document.styleSheets){var c=document.styleSheets[0];c.addRule(".otrvml_obj","{behavior: url(#default#VML);display:inline-block;z-index: 2}");c.addRule(".otrvml_line","{behavior: url(#default#VML);display:inline-block;z-index: 1}")}this._canvas=this._cfgs.doc.createElement(this._ns+":group");this._canvas.coordsize=this._cfgs.width+","+this._cfgs.height;this._canvas.style.cssText=d.join(";");if(undefined!=this._cfgs.id){this._canvas.id=this._cfgs.id}this._list=[]},getOrigin:function(){return{x:this._canvas.offsetLeft,y:this._canvas.offsetTop}},getDoc:function(){return this._cfgs.doc},getNs:function(){return this._ns}});(function(){var b=OTR.Graph.Vml;b.Brush=OTR.extend(OTR.Graph.Brush,{parseColor:function(l,n){var e=l.attr(n);if(OTR.Util.isString(e)){return e}if(e instanceof OTR.Graph.Color){var n=e.attr("type"),a=e.attr("colors"),r=this._adapter.getDoc(),p=this._adapter.getNs();if(a.length<=0){return"#000000"}if(n!="linear"&&n!="radia"){return a[0].color}var t=r.createElement(p+":fill");t.className="otrvml_obj";var j=[],q=e.attr("x"),o=e.attr("y"),u=e.attr("dx"),s=e.attr("dy"),m=a[a.length-1].color,f=a[0].color;for(var h=1,d=a.length-1;h<d;h++){j.push(a[h].offset*100+"%,"+a[h].color)}if(n=="linear"){var g;if(0!=u-q){g=Math.atan((s-o)/(u-q))/Math.PI*180}else{g=s>o?180:0}t.setAttribute("type","gradient");t.setAttribute("angel",g)}else{t.setAttribute("type",n)}t.setAttribute("color",m);t.setAttribute("color2",f);if(a.length){t.setAttribute("colors",j.reverse().join(" "))}return t}return"#000000"}});b.Rect=OTR.extend(b.Brush,{draw:function(){var i=this._adapter.getDoc(),h=this._shape,g=this._adapter.getNs(),f=this.parseColor(h,"background");var e=h.attr("borderRadius"),a,c=e==0?"Rect":"RoundRect";a=i.createElement(g+":"+c),cssText=["position:absolute","width:"+h.attr("width")+"px","height:"+h.attr("height")+"px","left:"+h.attr("x")+"px","top:"+h.attr("y")+"px"].join(";");a.className="otrvml_obj";a.style.cssText=cssText;a.strokecolor=h.attr("borderColor");a.strokeWeight=h.attr("borderWidth");if(e!=0){a.arcsize=e/h.attr("height")}if(typeof(f)=="string"){a.fillcolor=f}else{a.appendChild(f)}this._adapter.getCanvas().appendChild(a)}});b.Cycle=OTR.extend(b.Brush,{draw:function(){var h=this._adapter.getDoc(),g=this._shape,f=this._adapter.getNs(),c=this.parseColor(g,"background");var a=h.createElement(f+":oval"),e=["position:absolute","width:"+g.attr("width")+"px","height:"+g.attr("height")+"px","left:"+g.attr("x")+"px","top:"+g.attr("y")+"px",].join(";");a.className="otrvml_obj";a.style.cssText=e;a.strokecolor=g.attr("borderColor");a.strokeWeight=g.attr("borderWidth");if(typeof(c)=="string"){a.fillcolor=c}else{a.appendChild(c)}this._adapter.getCanvas().appendChild(a)}});b.Line=OTR.extend(b.Brush,{draw:function(){var j=this._adapter.getDoc(),h=this._shape,g=this._adapter.getNs();var c=j.createElement(g+":line"),i=j.createElement(g+":stroke");var f=["position:absolute"].join(";");c.className="otrvml_obj otrvml_line";c.style.cssText=f;c.from=h.attr("x")+","+h.attr("y");c.to=h.attr("dx")+","+h.attr("dy");c.strokecolor=h.attr("borderColor");c.strokeWeight=Math.max(1,h.attr("borderWidth"));var a=h.attr("startArrow"),e=h.attr("endArrow");if(a){i.setAttribute("StartArrow",a)}if(e){i.setAttribute("EndArrow",e)}i.className="otrvml_obj";c.appendChild(i);this._adapter.getCanvas().appendChild(c)}});b.PolyLine=OTR.extend(b.Brush,{draw:function(){var h=this._adapter.getDoc(),o=this._shape,j=this._adapter.getNs(),m=o.attr("points");if(!m||m.length<2){return}var q=h.createElement(j+":polyline"),n=h.createElement(j+":stroke");var c=["position:absolute"].join(";");q.className="otrvml_obj otrvml_line";q.style.cssText=c;var f=0,e=m.length,a=[];for(;f<e;f++){a.push(m[f].x+","+m[f].y)}q.points=a.join(" ");q.strokecolor=o.attr("borderColor");q.coordorig="0,0";q.strokeWeight=Math.max(1,o.attr("borderWidth"));var l=o.attr("startArrow"),g=o.attr("endArrow");if(l){n.setAttribute("StartArrow",l)}if(g){n.setAttribute("EndArrow",g)}n.className="otrvml_obj";q.appendChild(n);this._adapter.getCanvas().appendChild(q)}});b.Polygon=OTR.extend(b.Brush,{draw:function(){var h=this._adapter.getDoc(),m=this._shape,j=this._adapter.getNs(),l=m.getPoints(),f=this.parseColor(m,"background");if(!l||l.length<2){return}var n=h.createElement(j+":polyline");var c=["position:absolute"].join(";");n.className="otrvml_obj";n.style.cssText=c;var g=0,e=l.length,a=[];for(;g<e;g++){a.push(l[g].x+","+l[g].y)}a.push(l[0].x,l[0].y);n.points=a.join(" ");n.strokecolor=m.attr("borderColor");n.strokeWeight=Math.max(1,m.attr("borderWidth"));if(typeof(f)=="string"){n.fillcolor=f}else{n.appendChild(f)}this._adapter.getCanvas().appendChild(n)}});b.Text=OTR.extend(b.Brush,{draw:function(){var f=this._shape,i=f.attr("text"),g=f.attr("lineWidth");var h=this._adapter.getDoc(),f=this._shape,e=this._adapter.getNs();var a=h.createElement(e+":textbox"),c=["position:absolute","font-size:"+f.attr("fontSize"),"font-family:"+f.attr("fontFamily"),"color:"+f.attr("color"),"left:"+f.attr("x")+"px","top:"+f.attr("y")+"px",];if(g>0){css.Text.push("overflow:hidden; width: "+g+"px")}a.className="otrvml_obj";a.style.cssText=c.join(";");a.innerText=i;this._adapter.getCanvas().appendChild(a)}})})();